<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0, viewport-fit=cover">
    <title>Meu Cabelo</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400..900;1,400..900&family=Plus+Jakarta+Sans:wght@200..800&display=swap');
        
        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden; 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior: none; /* Previne o refresh nativo do browser */
            user-select: none;
        }
        
        .font-serif { font-family: 'Playfair Display', serif; }
        
        ::-webkit-scrollbar { display: none; }
        * { -ms-overflow-style: none; scrollbar-width: none; }
        
        .smooth-scroll {
            -webkit-overflow-scrolling: touch;
            overscroll-behavior-y: contain;
            scroll-behavior: smooth;
        }

        .animate-in { animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(15px); } 
            to { opacity: 1; transform: translateY(0); } 
        }

        /* ANIMA√á√ÉO DE CASCATA FLUIDA */
        .cascade-item {
            opacity: 0;
            animation: cascadeDownFluid 0.9s cubic-bezier(0.22, 1, 0.36, 1) forwards;
        }
        @keyframes cascadeDownFluid {
            0% { opacity: 0; transform: translateY(-40px); }
            100% { opacity: 1; transform: translateY(0); }
        }

        .toast-enter {
            animation: toastPopup 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }
        @keyframes toastPopup {
            0% { transform: translate(-50%, 10px) scale(0.8); opacity: 0; }
            100% { transform: translate(-50%, 0) scale(1); opacity: 1; }
        }

        .perspective-container { perspective: 1200px; }
        
        .flip-card-enter {
            animation: flipCardIn 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
            transform-style: preserve-3d;
            backface-visibility: hidden;
        }
        
        .flip-card-exit {
            animation: flipCardOut 0.4s cubic-bezier(0.6, -0.28, 0.735, 0.045) forwards;
            transform-style: preserve-3d;
            backface-visibility: hidden;
        }

        @keyframes flipCardIn {
            0% { transform: rotateY(-90deg) scale(0.9); opacity: 0; }
            100% { transform: rotateY(0deg) scale(1); opacity: 1; }
        }
        
        @keyframes flipCardOut {
            0% { transform: rotateY(0deg) scale(1); opacity: 1; }
            100% { transform: rotateY(90deg) scale(0.9); opacity: 0; }
        }

        .grip-animate {
            animation: breathe 3s ease-in-out infinite;
        }
        @keyframes breathe {
            0%, 100% { transform: scale(1); opacity: 0.6; }
            50% { transform: scale(1.15); opacity: 1; }
        }

        @media screen and (max-width: 768px) {
            input, select, textarea { font-size: 16px !important; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script>
        window.addEventListener('error', function(e) {
            const errDiv = document.createElement('div');
            errDiv.style.cssText = 'position:fixed;top:20px;left:20px;right:20px;background:#ef4444;color:white;padding:15px;border-radius:12px;z-index:99999;font-family:sans-serif;box-shadow:0 10px 25px rgba(0,0,0,0.2);';
            errDiv.innerHTML = '<b style="font-size:16px;">üö® Erro na Aplica√ß√£o:</b><br><br>' + e.message + '<br><br><small>Abra a consola (F12) para ver detalhes.</small>';
            document.body.appendChild(errDiv);
        });
    </script>

    <script type="text/babel" data-type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBf1QNBMm8vtqVZoiwDxDYtLqAEDIRAudQ",
            authDomain: "meu-cabelo-app.firebaseapp.com",
            projectId: "meu-cabelo-app",
            storageBucket: "meu-cabelo-app.firebasestorage.app",
            messagingSenderId: "348474330654",
            appId: "1:348474330654:web:af75d39dc2ea95b479280f"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'meu-cabelo-app';

        const { useState, useEffect, useMemo, useRef } = React;

        const getThemeColors = (isDark) => ({
            bg: isDark ? 'bg-[#1C1A19]' : 'bg-[#F9F6F0]',
            card: isDark ? 'bg-[#282624]' : 'bg-white',
            surface: isDark ? 'bg-[#32302D]' : 'bg-stone-50',
            surfaceHover: isDark ? 'hover:bg-[#3D3A36]' : 'hover:bg-stone-100',
            surfaceAlt: isDark ? 'bg-[#3D3A36]' : 'bg-stone-100',
            text: isDark ? 'text-[#D6D0C4]' : 'text-[#5C544E]',
            textStrong: isDark ? 'text-[#F0EBE1]' : 'text-stone-700',
            textMuted: isDark ? 'text-[#A39D93]' : 'text-stone-500',
            textLight: isDark ? 'text-[#8A847A]' : 'text-[#9A8F85]',
            iconMuted: isDark ? 'text-[#5A5550]' : 'text-stone-300',
            primary: isDark ? 'bg-[#384A41]' : 'bg-[#D2E0D9]',
            primaryText: isDark ? 'text-[#A5C2B3]' : 'text-[#4A6B5D]',
            accent: isDark ? 'bg-[#5C3C3A]' : 'bg-[#F3D8D6]',
            accentText: isDark ? 'text-[#DEAAA7]' : 'text-[#9C5A56]',
            yellow: isDark ? 'bg-[#4A3D1A]' : 'bg-[#FDF3D8]',
            yellowText: isDark ? 'text-[#E0BE63]' : 'text-[#B08922]',
            blue: isDark ? 'bg-[#2C3E4F]' : 'bg-[#D6E4F0]',
            blueText: isDark ? 'text-[#9CB8D4]' : 'text-[#4A6984]',
            purple: isDark ? 'bg-[#3D2C4A]' : 'bg-[#E5D9F2]',
            purpleText: isDark ? 'text-[#BCA3D4]' : 'text-[#7A5C8A]',
            orange: isDark ? 'bg-[#5A3A22]' : 'bg-[#FFE5D4]',
            orangeText: isDark ? 'text-[#ECA16A]' : 'text-[#C76A28]',
            greenCard: isDark ? 'bg-[#2A402A]' : 'bg-[#E0F0E0]',
            greenText: isDark ? 'text-[#7BB07B]' : 'text-[#3B7A3B]',
            teal: isDark ? 'bg-[#214040]' : 'bg-[#E0F0F0]',
            tealText: isDark ? 'text-[#5EB0B0]' : 'text-[#3B7A7A]',
            emerald: isDark ? 'bg-[#20402E]' : 'bg-[#E0F0E6]',
            emeraldText: isDark ? 'text-[#63B88A]' : 'text-[#3B7A55]',
            border: isDark ? 'border-[#3D3A36]' : 'border-[#EAE3D9]',
            bottomNav: isDark ? 'bg-[#282624]/90 border-[#3D3A36]' : 'bg-white/90 border-[#EAE3D9]',
            input: isDark ? 'bg-[#1C1A19] text-[#D6D0C4]' : 'bg-white text-stone-700',
            translucent: isDark ? 'bg-black/20' : 'bg-white/60',
            translucentStrong: isDark ? 'bg-black/40' : 'bg-white/70',
            notification: isDark ? 'bg-[#282624]/95 border-[#3D3A36]' : 'bg-white/95 border-stone-200',
            indigoCard: isDark ? 'bg-indigo-900/20 border-indigo-900/50' : 'bg-indigo-50/30 border-indigo-100',
            indigoText: isDark ? 'text-indigo-300' : 'text-indigo-900',
            blueCard: isDark ? 'bg-blue-900/20 border-blue-900/50' : 'bg-blue-50/30 border-blue-100',
            blueTextAlt: isDark ? 'text-blue-300' : 'text-blue-900',
            purpleCard: isDark ? 'bg-purple-900/20 border-purple-900/50' : 'bg-[#E5D9F2] bg-opacity-30 border-purple-100',
        });

        const HAIR_STATUS = [
            { id: 'danificado', icon: 'ph-warning-circle', color: 'text-orange-500', label: 'Danificado', desc: 'Fios el√°sticos, quebra f√°cil. Precisa de reconstru√ß√£o urgente.' },
            { id: 'seco', icon: 'ph-wind', color: 'text-yellow-600', label: 'Seco / Frizz', desc: 'Fios √°speros e sem brilho. Precisa de nutri√ß√£o e √≥leos.' },
            { id: 'oleoso', icon: 'ph-drop-half', color: 'text-stone-400', label: 'Oleoso', desc: 'Raiz pesada e excesso de sebo. Evite √°gua muito quente.' },
            { id: 'normal', icon: 'ph-smiley', color: 'text-yellow-400', label: 'Bom', desc: 'Saud√°vel e equilibrado. A sua rotina est√° a funcionar!' },
            { id: 'hidratado', icon: 'ph-drop', color: 'text-blue-400', label: 'Hidratado', desc: 'Macio, solto e com a √°gua reposta. Toque de seda.' },
            { id: 'perfeito', icon: 'ph-sparkle', color: 'text-pink-400', label: 'Incr√≠vel', desc: 'Brilho espelhado, selado e muito forte. Dia de cabelo perfeito!' },
        ];

        const TREATMENT_TYPES = [
            { id: 'hidratacao', label: 'üíß Hidrata√ß√£o', val: 1 },
            { id: 'nutricao', label: 'ü•ë Nutri√ß√£o', val: 2 },
            { id: 'reconstrucao', label: 'üõ°Ô∏è Reconstru√ß√£o', val: 3 },
            { id: 'detox', label: 'üåø Detox', val: 4 },
        ];

        const SALON_INFO = {
            'Corte': 'Remove pontas duplas, devolve movimento e encorpa os fios.',
            'Pintura Global': 'Altera a cor do fio. Exige reconstru√ß√£o para repor a massa perdida.',
            'Madeixas / Luzes': 'Descolora√ß√£o profunda. Aumenta muito a porosidade, precisa de nutri√ß√£o.',
            'Escova / Styling': 'Alinhamento t√©rmico. O brilho √© tempor√°rio, reforce a hidrata√ß√£o.',
            'Hidrata√ß√£o Profissional': 'Reposi√ß√£o intensa e profunda de √°gua com tecnologia de sal√£o.',
            'Reconstru√ß√£o (Sal√£o)': 'Inje√ß√£o de queratina para salvar fios el√°sticos ou p√≥s-qu√≠mica.',
            'Botox / Progressiva': 'Altera a estrutura do fio. Pode afinar o cabelo com o tempo.'
        };

        const STAT_PERIODS = [
            { val: 'custom', label: 'Personalizado', icon: 'ph-calendar' },
            { val: 'ontem', label: 'Ontem' },
            { val: 7, label: '7 D' },
            { val: 15, label: '15 D' },
            { val: 30, label: '30 D' },
            { val: 60, label: '60 D' },
            { val: 90, label: '90 D' }
        ];

        const WEEKDAYS = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'];
        const MONTHS = ['Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];

        const dateObjToStr = (d) => `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
        
        const getTodayStr = () => dateObjToStr(new Date());

        const addDaysStr = (dateStr, days) => {
            const [y, m, d] = dateStr.split('-');
            const date = new Date(y, m - 1, d);
            date.setDate(date.getDate() + days);
            return dateObjToStr(date);
        };

        const formatTime = (date) => `${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
        
        const formatDateVisual = (dateStr) => {
            if(!dateStr) return '';
            const [y, m, d] = dateStr.split('-');
            const date = new Date(y, m - 1, d);
            return `${date.getDate()} de ${MONTHS[date.getMonth()]}, ${y}`;
        };

        const INITIAL_USERS_DB = {};

        const Button = ({ children, onClick, variant = 'primary', className = '', colors, style }) => {
            const variants = {
                primary: `${colors.primary} ${colors.primaryText} hover:brightness-110`,
                accent: `${colors.accent} ${colors.accentText} hover:brightness-110`,
                purple: `${colors.purple} ${colors.purpleText} hover:brightness-110`,
                blue: `${colors.blue} ${colors.blueText} hover:brightness-110`,
                orange: `${colors.orange} ${colors.orangeText} hover:brightness-110`,
                teal: `${colors.teal} ${colors.tealText} hover:brightness-110`,
                emerald: `${colors.emerald} ${colors.emeraldText} hover:brightness-110`,
                outline: `border-2 ${colors.border} ${colors.text} ${colors.surfaceHover}`,
            };
            return <button type="button" onClick={onClick} style={style} className={`px-4 py-2 rounded-2xl font-bold transition-all flex items-center justify-center gap-2 ${variants[variant]} ${className}`}>{children}</button>;
        };

        const Card = ({ children, className = '', colors, onClick, style }) => (
            <div onClick={onClick} style={style} className={`${colors.card} rounded-3xl p-6 shadow-sm border ${colors.border} transition-transform duration-300 ${onClick ? 'cursor-pointer hover:scale-[1.02] hover:shadow-md' : ''} ${className}`}>{children}</div>
        );

        function App() {
            const [notifications, setNotifications] = useState([]);
            
            const addNotification = (msg, isError = false) => {
                const id = Date.now();
                setNotifications(prev => [...prev, { id, msg, isError }]);
                setTimeout(() => setNotifications(prev => prev.filter(n => n.id !== id)), 6000);
            };

            const [user, setUser] = useState(null);
            
            useEffect(() => {
                const initAuth = async () => {
                    try {
                        if (typeof window !== 'undefined' && window.__initial_auth_token) {
                            await signInWithCustomToken(auth, window.__initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Erro na Autentica√ß√£o Firebase:", error);
                        addNotification("üö® Erro de Liga√ß√£o: V√° √† consola Firebase > Authentication > ative 'Anonymous'.", true);
                    }
                };
                initAuth();
                const unsubscribe = onAuthStateChanged(auth, setUser);
                return () => unsubscribe();
            }, []);

            const [deferredPrompt, setDeferredPrompt] = useState(null);
            useEffect(() => {
                const handleBIP = (e) => { e.preventDefault(); setDeferredPrompt(e); };
                window.addEventListener('beforeinstallprompt', handleBIP);
                return () => window.removeEventListener('beforeinstallprompt', handleBIP);
            }, []);

            const [isDarkMode, setIsDarkMode] = useState(false);
            const colors = useMemo(() => getThemeColors(isDarkMode), [isDarkMode]);
            const toggleTheme = () => setIsDarkMode(!isDarkMode);

            const [usersDb, setUsersDb] = useState(INITIAL_USERS_DB);
            const [currentUsername, setCurrentUsername] = useState(null);

            const [authStep, setAuthStep] = useState('auth'); 
            const [isLoginFlow, setIsLoginFlow] = useState(true);
            const [userName, setUserName] = useState('');

            const [usernameInput, setUsernameInput] = useState('');
            const [passwordInput, setPasswordInput] = useState('');
            const [securityAnswerInput, setSecurityAnswerInput] = useState('');

            const [showTutorial, setShowTutorial] = useState(false);
            const [dontShowTutorialAgain, setDontShowTutorialAgain] = useState(false);
            
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            const [isClosingSettings, setIsClosingSettings] = useState(false);
            const [editNameInput, setEditNameInput] = useState('');
            const [editPasswordInput, setEditPasswordInput] = useState('');

            const [pastProductPrompt, setPastProductPrompt] = useState(null);
            const [refreshTrigger, setRefreshTrigger] = useState(0);

            const TABS_ORDER = ['home', 'calendar', 'stats'];
            const [activeTab, setActiveTab] = useState('home');
            
            const [realTodayStr, setRealTodayStr] = useState(getTodayStr());
            const [activeDateStr, setActiveDateStr] = useState(getTodayStr()); 
            
            useEffect(() => {
                const interval = setInterval(() => {
                    const nowStr = getTodayStr();
                    if (nowStr !== realTodayStr) {
                        setRealTodayStr(nowStr);
                        if (activeDateStr === realTodayStr || activeDateStr === '') {
                            setActiveDateStr(nowStr);
                        }
                    }
                }, 60000);
                return () => clearInterval(interval);
            }, [realTodayStr, activeDateStr]);
            
            const [isNavOpen, setIsNavOpen] = useState(false);
            const navTouchStartY = useRef(0);
            const isNavDragging = useRef(false);
            
            const [activeStatModal, setActiveStatModal] = useState(null);
            const [isClosingModal, setIsClosingModal] = useState(false);

            const [statusFeedback, setStatusFeedback] = useState(null);
            const statusTimeoutRef = useRef(null);

            const [logs, setLogs] = useState({});
            const [products, setProducts] = useState([]);

            const [extraInput, setExtraInput] = useState({ type: '', duration: '' });
            const [salonInput, setSalonInput] = useState({ procedures: [], mood: 'perfeito' });

            const [isAddingProduct, setIsAddingProduct] = useState(false);
            const [newProductInput, setNewProductInput] = useState({ name: '', time: '08:00' });
            
            const [statsPeriod, setStatsPeriod] = useState('ontem');
            const [viewingMonth, setViewingMonth] = useState(new Date());
            const [selectedHistoryDate, setSelectedHistoryDate] = useState(getTodayStr());

            const [isCustomDateOpen, setIsCustomDateOpen] = useState(false);
            const [isClosingCustomDate, setIsClosingCustomDate] = useState(false);
            const [customStart, setCustomStart] = useState(addDaysStr(getTodayStr(), -7));
            const [customEnd, setCustomEnd] = useState(getTodayStr());

            // --- L√ìGICA DO PULL TO REFRESH NO SOLTAR ---
            const pullStartY = useRef(null);
            const [pullDistance, setPullDistance] = useState(0);

            const scrollToTop = () => {
                document.querySelectorAll('.smooth-scroll').forEach(el => el.scrollTo({ top: 0, behavior: 'smooth' }));
            };

            const triggerRefresh = () => {
                scrollToTop();
                if (authStep === 'app') {
                    handleNavMenuClick('home'); 
                }
                setRefreshTrigger(p => p + 1); 
                if(navigator.vibrate) navigator.vibrate(50);
            };

            const handlePullTouchStart = (e) => {
                if (e.currentTarget.scrollTop <= 0) {
                    pullStartY.current = e.touches[0].clientY;
                } else {
                    pullStartY.current = null;
                }
            };

            const handlePullTouchMove = (e) => {
                if (!pullStartY.current) return;
                const dy = e.touches[0].clientY - pullStartY.current;
                if (dy > 0) {
                    setPullDistance(dy);
                }
            };

            const handlePullTouchEnd = () => {
                if (pullDistance > 110) {
                    triggerRefresh();
                }
                setPullDistance(0);
                pullStartY.current = null;
            };
            // ------------------------------------------

            useEffect(() => {
                if (!user) return;
                try {
                    const usersRef = collection(db, 'artifacts', appId, 'public', 'data', 'users');
                    const unsubscribe = onSnapshot(usersRef, (snapshot) => {
                        const dbUsers = {};
                        snapshot.forEach(doc => { dbUsers[doc.id] = doc.data(); });
                        setUsersDb(prev => ({ ...INITIAL_USERS_DB, ...dbUsers }));
                    }, (error) => {
                        console.error("Firestore read error:", error);
                        addNotification("üö® Erro Base de Dados: Verifique as regras de seguran√ßa no Firestore.", true);
                    });
                    return () => unsubscribe();
                } catch (e) { console.error("Setup Firestore error:", e); }
            }, [user]);

            useEffect(() => {
                if (currentUsername && authStep === 'app' && user) {
                    setUsersDb(prev => ({ ...prev, [currentUsername]: { ...prev[currentUsername], logs, products } }));
                    const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', currentUsername);
                    setDoc(userRef, { logs, products }, { merge: true }).catch(err => {
                        console.error(err); addNotification("üö® Erro ao guardar registo no Firestore.", true);
                    });
                }
            }, [logs, products, currentUsername, authStep, user]);

            const getSafeDayLog = (dateStr) => {
                const log = logs[dateStr] || {};
                return {
                    status: log.status || [],
                    washed: log.washed || false,
                    treatment: log.treatment || { minutes: 0, type: '' },
                    routine: log.routine || {},
                    heat: log.heat || { active: false, protectant: false },
                    salon: log.salon || null,
                    extras: log.extras || []
                };
            };

            const dayLog = getSafeDayLog(activeDateStr);

            const updateActiveLog = (key, value) => {
                setLogs(prev => {
                    const safeLog = getSafeDayLog(activeDateStr);
                    return { ...prev, [activeDateStr]: { ...safeLog, [key]: value } };
                });
            };

            const handleStatusSelect = (s) => {
                updateActiveLog('status', [...dayLog.status, {time: formatTime(new Date()), status: s.id}]);
                setStatusFeedback(s.label);
                if (statusTimeoutRef.current) clearTimeout(statusTimeoutRef.current);
                statusTimeoutRef.current = setTimeout(() => { setStatusFeedback(null); }, 2000);
            };

            const handleAuthSubmit = () => {
                if (!usernameInput || !passwordInput) return addNotification("Preencha utilizador e palavra-passe!", true);
                const userKey = usernameInput.toLowerCase().trim();
                if (isLoginFlow) {
                    const userAccount = usersDb[userKey];
                    if (userAccount && userAccount.password === passwordInput) {
                        setCurrentUsername(userKey); setUserName(userAccount.name); setLogs(userAccount.logs || {}); 
                        setProducts(userAccount.products || []); setActiveDateStr(getTodayStr()); setSelectedHistoryDate(getTodayStr()); setIsNavOpen(false); 
                        setAuthStep('app'); setActiveTab('home'); setStatsPeriod('ontem'); setRefreshTrigger(p=>p+1);
                        if (!userAccount.hideTutorial) setShowTutorial(true); 
                    } else addNotification("Utilizador ou palavra-passe incorretos!", true);
                } else {
                    if (usersDb[userKey]) return addNotification("Este utilizador j√° existe!", true);
                    setLogs({}); setProducts([]); setSecurityAnswerInput(''); setAuthStep('onboarding'); setRefreshTrigger(p=>p+1);
                }
            };

            const handleOnboardingSubmit = async () => {
                if (!userName.trim() || !securityAnswerInput.trim()) return addNotification("Por favor, preencha todos os campos!", true);
                if (!user) return addNotification("üö® A aguardar liga√ß√£o ao Firebase. Tente em 2 segundos...", true);
                
                const userKey = usernameInput.toLowerCase().trim();
                const newUser = { password: passwordInput, name: userName.trim(), securityAnswer: securityAnswerInput.toLowerCase().trim(), logs: {}, products: [] };

                setUsersDb(prev => ({ ...prev, [userKey]: newUser }));
                
                try {
                    const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', userKey);
                    await setDoc(userRef, newUser);
                    addNotification("Conta criada com sucesso! Bem-vinda.");
                    setCurrentUsername(userKey); setIsNavOpen(false); setAuthStep('app'); setActiveTab('home'); setStatsPeriod('ontem'); setActiveDateStr(getTodayStr()); setSelectedHistoryDate(getTodayStr()); setRefreshTrigger(p=>p+1); setShowTutorial(true);
                } catch (e) {
                    console.error("Erro ao salvar no Firestore:", e); addNotification(`üö® Erro ao guardar conta. Regras bloqueadas.`, true);
                }
            };

            const handleRecoverySubmit = () => {
                if (!usernameInput || !securityAnswerInput) return addNotification("Preencha o utilizador e o nome da av√≥!", true);
                const userKey = usernameInput.toLowerCase().trim();
                const userAccount = usersDb[userKey];
                if (userAccount && userAccount.securityAnswer === securityAnswerInput.toLowerCase().trim()) {
                    addNotification(`A sua palavra-passe √©: ${userAccount.password}`);
                    setTimeout(() => { setAuthStep('auth'); setRefreshTrigger(p=>p+1); }, 4000); 
                } else addNotification("Utilizador ou resposta secreta incorretos.", true);
            };

            const handleLogout = () => {
                setAuthStep('auth'); setIsLoginFlow(true); setCurrentUsername(null); setUserName('');
                setUsernameInput(''); setPasswordInput(''); setSecurityAnswerInput('');
                setLogs({}); setProducts([]); setActiveDateStr(getTodayStr()); setSelectedHistoryDate(getTodayStr());
                setExtraInput({ type: '', duration: '' }); setSalonInput({ procedures: [], mood: 'perfeito' });
                setNewProductInput({ name: '', time: '08:00' }); setIsAddingProduct(false); setShowTutorial(false); setPastProductPrompt(null); setDontShowTutorialAgain(false);
                setIsSettingsOpen(false);
                setRefreshTrigger(p=>p+1);
            };

            const handleOpenSettings = () => {
                setEditNameInput(userName);
                setEditPasswordInput(usersDb[currentUsername]?.password || '');
                setIsSettingsOpen(true);
            };

            const handleCloseSettings = async () => {
                setIsClosingSettings(true);
                setTimeout(async () => {
                    setIsSettingsOpen(false);
                    setIsClosingSettings(false);
                    
                    let updates = {};
                    let changed = false;
                    if (editNameInput.trim() && editNameInput.trim() !== userName) {
                        updates.name = editNameInput.trim();
                        setUserName(editNameInput.trim());
                        changed = true;
                    }
                    if (editPasswordInput.trim() && editPasswordInput.trim() !== usersDb[currentUsername].password) {
                        updates.password = editPasswordInput.trim();
                        changed = true;
                    }

                    if (changed) {
                        setUsersDb(prev => ({ ...prev, [currentUsername]: { ...prev[currentUsername], ...updates } }));
                        if (user) {
                            try {
                                const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', currentUsername);
                                await setDoc(userRef, updates, { merge: true });
                                addNotification("Defini√ß√µes guardadas com sucesso!");
                            } catch(e) { console.error(e); addNotification("Erro ao atualizar defini√ß√µes no servidor.", true); }
                        }
                    }
                }, 350);
            };

            const handleCloseTutorial = async () => {
                setShowTutorial(false);
                if (dontShowTutorialAgain && currentUsername && user) {
                    setUsersDb(prev => ({...prev, [currentUsername]: {...prev[currentUsername], hideTutorial: true}}));
                    try {
                        const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', currentUsername);
                        await setDoc(userRef, { hideTutorial: true }, { merge: true });
                    } catch(e) { console.error(e); }
                }
            };

            const handleCloseCustomDate = () => {
                setIsClosingCustomDate(true);
                setTimeout(() => {
                    setIsCustomDateOpen(false);
                    setIsClosingCustomDate(false);
                }, 350);
            };

            // Voltar para hoje ao navegar no menu e ir para o topo
            const handleNavMenuClick = (tab) => {
                setActiveTab(tab);
                setIsNavOpen(false);
                scrollToTop();
                if (tab === 'stats') setStatsPeriod('ontem');
                if (activeDateStr !== realTodayStr) setActiveDateStr(realTodayStr);
                if (selectedHistoryDate !== realTodayStr) setSelectedHistoryDate(realTodayStr);
            };

            const handleNavTouchStart = (e) => { navTouchStartY.current = e.touches[0].clientY; isNavDragging.current = false; };
            const handleNavTouchMove = (e) => {
                const deltaY = e.touches[0].clientY - navTouchStartY.current;
                if (Math.abs(deltaY) > 10) isNavDragging.current = true;
            };
            const handleNavTouchEnd = (e) => {
                if (!isNavDragging.current) return; 
                const deltaY = e.changedTouches[0].clientY - navTouchStartY.current;
                if (deltaY < -15) setIsNavOpen(true); else if (deltaY > 15) setIsNavOpen(false);
            };
            const handleNavClick = (e) => {
                e.stopPropagation();
                if (isNavDragging.current) { isNavDragging.current = false; return; }
                setIsNavOpen(prev => !prev);
            };

            const activeIndex = TABS_ORDER.indexOf(activeTab);

            // ADICIONAR PRODUTO
            const handleAddProduct = () => {
                if (newProductInput.name) {
                    const newId = Date.now().toString();
                    const newProd = { 
                        id: newId, 
                        name: newProductInput.name, 
                        time: newProductInput.time, 
                        createdAt: activeDateStr
                    };

                    if (activeDateStr < realTodayStr) {
                        setPastProductPrompt(newProd);
                        setIsAddingProduct(false);
                        setNewProductInput({ name: '', time: '08:00' });
                    } else {
                        setProducts([...products, newProd]);
                        setNewProductInput({ name: '', time: '08:00' });
                        setIsAddingProduct(false);
                    }
                } else {
                    addNotification("Preencha o nome do produto!", true);
                }
            };

            const handlePastProductDecision = (decision) => {
                const prod = pastProductPrompt;
                let finalProducts = [...products];
                let newLogs = { ...logs };

                if (decision === 'SINGLE_USE') {
                    const nextDay = addDaysStr(prod.createdAt, 1);
                    prod.archivedAt = nextDay;
                    finalProducts.push(prod);
                } else if (decision === 'CHECK_ALL' || decision === 'ADD_ONLY') {
                    finalProducts.push(prod);
                    if (decision === 'CHECK_ALL') {
                        let currDate = prod.createdAt;
                        while (currDate <= realTodayStr) {
                            const existingLog = newLogs[currDate] || {};
                            const existingRoutine = existingLog.routine || {};
                            newLogs[currDate] = { ...existingLog, routine: { ...existingRoutine, [prod.id]: true } };
                            currDate = addDaysStr(currDate, 1);
                        }
                    }
                }
                
                setProducts(finalProducts);
                if (decision === 'CHECK_ALL') setLogs(newLogs);
                setPastProductPrompt(null);
                addNotification("Produto configurado com sucesso!");
            };

            const handleRemoveProduct = (prodId) => {
                if (activeDateStr === realTodayStr) {
                    setProducts(products.map(p => p.id === prodId ? { ...p, archivedAt: activeDateStr } : p));
                } else {
                    setProducts(products.map(p => p.id === prodId ? { ...p, hiddenDates: [...(p.hiddenDates || []), activeDateStr] } : p));
                }
            };

            const toggleSalonProcedure = (proc) => {
                setSalonInput(prev => {
                    const arr = prev.procedures || [];
                    if (arr.includes(proc)) return { ...prev, procedures: arr.filter(p => p !== proc) };
                    return { ...prev, procedures: [...arr, proc] };
                });
            };

            const handleEditSalon = () => {
                const existing = dayLog.salon;
                let procs = Array.isArray(existing.procedures) ? existing.procedures : (existing.procedures || '').split(', ').filter(Boolean);
                setSalonInput({ procedures: procs, mood: existing.mood || 'perfeito' });
                updateActiveLog('salon', null);
            };

            const stats = useMemo(() => {
                const today = new Date();
                let treatUses = 0, productUsed = 0, productTotal = 0;
                let heatDays = 0, protectedDays = 0, totalSalon = 0, totalExtrasMins = 0;
                let totalWashes = 0; 
                
                let countCorte = 0, countCor = 0, countEscova = 0, countReconstrucao = 0;

                const statusCounts = {}, salonMoodCounts = {}, maskTypeCounts = {};

                let datesToCheck = [];
                if (statsPeriod === 'ontem') {
                    datesToCheck.push(addDaysStr(getTodayStr(), -1));
                } else if (typeof statsPeriod === 'number') {
                    for (let i = 0; i < statsPeriod; i++) {
                        datesToCheck.push(addDaysStr(getTodayStr(), -i));
                    }
                } else if (statsPeriod === 'custom') {
                    let curr = new Date(customStart);
                    let end = new Date(customEnd);
                    while (curr <= end) {
                        datesToCheck.push(dateObjToStr(curr));
                        curr.setDate(curr.getDate() + 1);
                    }
                }

                datesToCheck.forEach(dateStr => {
                    const l = logs[dateStr];

                    const activeProds = products.filter(p => 
                        (!p.createdAt || p.createdAt <= dateStr) && 
                        (!p.archivedAt || p.archivedAt > dateStr) &&
                        !(p.hiddenDates && p.hiddenDates.includes(dateStr))
                    );
                    
                    if (l) {
                        if (l.washed) totalWashes++;
                        if (l.treatment?.minutes) { 
                            treatUses++; 
                            if(l.treatment.type) maskTypeCounts[l.treatment.type] = (maskTypeCounts[l.treatment.type] || 0) + 1;
                        }
                        
                        productTotal += activeProds.length;
                        activeProds.forEach(p => { if (l.routine?.[p.id]) productUsed++; });

                        if (l.heat?.active) { heatDays++; if (l.heat.protectant) protectedDays++; }
                        l.extras?.forEach(ex => { totalExtrasMins += ex.duration; });

                        if (l.salon?.procedures) {
                            totalSalon++;
                            let procs = Array.isArray(l.salon.procedures) ? l.salon.procedures : (l.salon.procedures || '').split(', ');
                            procs.forEach(p => {
                                const pText = p.toLowerCase();
                                if (pText.includes('cort')) countCorte++;
                                if (pText.includes('pint') || pText.includes('madeix') || pText.includes('luzes')) countCor++;
                                if (pText.includes('escov')) countEscova++;
                                if (pText.includes('reconstru')) countReconstrucao++;
                            });
                            if (l.salon.mood) salonMoodCounts[l.salon.mood] = (salonMoodCounts[l.salon.mood] || 0) + 1;
                        }
                        l.status?.forEach(m => { statusCounts[m.status] = (statusCounts[m.status] || 0) + 1; });
                    }
                });

                const routineAdherence = productTotal === 0 ? null : Math.round((productUsed / productTotal) * 100);
                const topStatusId = Object.keys(statusCounts).sort((a,b) => statusCounts[b] - statusCounts[a])[0];
                const topStatus = HAIR_STATUS.find(m => m.id === topStatusId) || HAIR_STATUS.find(m => m.id === 'normal'); 
                const topSalonMoodId = Object.keys(salonMoodCounts).sort((a,b) => salonMoodCounts[b] - salonMoodCounts[a])[0];
                const topSalonMood = HAIR_STATUS.find(m => m.id === topSalonMoodId) || null;

                const topMasks = Object.entries(maskTypeCounts).sort((a,b) => b[1] - a[1]).slice(0, 2).map(m => TREATMENT_TYPES.find(t => t.id === m[0])?.label || m[0]);

                return { 
                    treatUses, routineAdherence, heatDays, protectedDays, totalSalon, 
                    countCorte, countCor, countEscova, countReconstrucao, totalExtrasMins, 
                    totalWashes, topStatus, topSalonMood, topMasks, daysCount: datesToCheck.length 
                };
            }, [statsPeriod, logs, products, customStart, customEnd]);

            const getInsightFor = (type) => {
                switch(type) {
                    case 'status': 
                        const goodStatuses = ['normal', 'hidratado', 'perfeito'];
                        if (goodStatuses.includes(stats.topStatus.id)) return "O seu cabelo tem estado incr√≠vel! A sua rotina atual est√° claramente a dar resultados positivos.";
                        if (stats.topStatus.id === 'oleoso') return "A oleosidade √© uma prote√ß√£o natural do couro cabeludo. Evite lavar com √°gua muito quente e n√£o esfregue o couro com for√ßa, pois isso causa 'efeito rebote' (produz mais √≥leo para compensar). Prefira shampoos equilibrantes e aplique √≥leos s√≥ nas pontas.";
                        return "Parece que os fios andam a pedir socorro. Aumente a frequ√™ncia das m√°scaras de nutri√ß√£o e umecta√ß√£o com √≥leos para devolver a maleabilidade.";
                    
                    case 'washed':
                        if (stats.totalWashes === 0) return "N√£o registou nenhuma lavagem neste per√≠odo. √â crucial lavar o couro cabeludo regularmente para evitar a obstru√ß√£o dos fol√≠culos, caspa e queda de cabelo.";
                        const freq = (stats.daysCount / stats.totalWashes).toFixed(1);
                        if (freq < 1.5) {
                            return `Lavou o cabelo quase todos os dias (m√©dia de 1 lavagem a cada ${freq.replace('.0', '')} dias). Lavar excessivamente pode retirar a oleosidade natural, causando ressecamento das pontas ou efeito rebote na raiz. Avalie se o seu cabelo realmente necessita de lavagem di√°ria.`;
                        } else if (freq >= 1.5 && freq <= 3.5) {
                            return `Frequ√™ncia ideal! (m√©dia de 1 lavagem a cada ${freq.replace('.0', '')} dias). Manter a lavagem a cada 2 a 3 dias ajuda a equilibrar a oleosidade do couro cabeludo sem ressecar o comprimento dos fios.`;
                        } else {
                            return `Lavagem pouco frequente (m√©dia de 1 lavagem a cada ${freq.replace('.0', '')} dias). Passar muitos dias sem lavar pode acumular res√≠duos, suor e sebo no couro cabeludo, o que enfraquece a raiz e retarda o crescimento.`;
                        }

                    case 'routine': 
                        if (stats.routineAdherence === null) return "N√£o configurou ou n√£o teve produtos ativos no seu uso di√°rio neste per√≠odo selecionado.";
                        return stats.routineAdherence === 100 ? "Perfeito! A sua ades√£o aos produtos di√°rios est√° no m√°ximo. A const√¢ncia √© o maior segredo capilar." : stats.routineAdherence > 80 ? "Disciplina de ferro! Tem usado os seus produtos quase todos os dias." : "Tem esquecido de aplicar os seus produtos di√°rios. Sem const√¢ncia, os produtos n√£o conseguem entregar o resultado prometido!";
                    
                    case 'treatment': 
                        let maskMsg = `Utilizou m√°scaras ${stats.treatUses} vez(es) neste per√≠odo. `;
                        if(stats.treatUses > 0) {
                            if(stats.topMasks.length > 0) maskMsg += `As suas etapas favoritas foram: ${stats.topMasks.join(' e ')}. Mantenha o equil√≠brio do cronograma para evitar quebra.`;
                            else maskMsg += "Lembre-se de intercalar entre Hidrata√ß√£o, Nutri√ß√£o e Reconstru√ß√£o.";
                        } else {
                            maskMsg = "N√£o registou nenhuma m√°scara neste per√≠odo. O cabelo perde √°gua e massa diariamente, precisa de as repor semanalmente!";
                        }
                        return maskMsg;
                    
                    case 'heat': 
                        if (stats.heatDays === 0) return "Excelente! N√£o usou calor neste per√≠odo. Secar ao natural √© a melhor escolha para manter as pontas cheias e saud√°veis.";
                        if (stats.protectedDays === stats.heatDays) return `Perfeito! Usou fontes de calor em ${stats.heatDays} dias, mas protegeu SEMPRE o fio. O protetor t√©rmico cria uma pel√≠cula invis√≠vel que salva o cabelo da quebra.`;
                        if (stats.protectedDays > 0) return `Aten√ß√£o! Usou calor em ${stats.heatDays} dias, mas esqueceu o protetor em alguns. O calor direto sem prote√ß√£o causa danos irrevers√≠veis na hora!`;
                        return `Alerta m√°ximo! Usou secador/chapinha em ${stats.heatDays} dias e N√ÉO aplicou prote√ß√£o t√©rmica em nenhum. Est√° a cozinhar a queratina do seu cabelo, introduza um protetor urgente!`;
                    
                    case 'salon': 
                        if (stats.totalSalon === 0) return `Ainda n√£o tirou um momento para se mimar no sal√£o neste per√≠odo. Agendar um dia de puro autocuidado faz maravilhas pela autoestima!`;
                        
                        let msgs = [];
                        if (stats.countCor > 0 && stats.countReconstrucao > 0) msgs.push(`Excelente escolha! Combinou qu√≠mica (cor/madeixas) com reconstru√ß√£o no sal√£o, protegendo a massa estrutural do fio.`);
                        else if (stats.countCor > 0) msgs.push(`Fez qu√≠mica sem registar reconstru√ß√£o profunda no sal√£o. A qu√≠mica deixa o fio muito poroso, por isso reforce os tratamentos em casa nas pr√≥ximas semanas!`);
                        
                        if (stats.countCorte > 0) msgs.push(`Manter o corte em dia √© o melhor tratamento contra o afinamento das pontas e devolve o movimento natural.`);
                        if (stats.countEscova > 0) msgs.push(`O cabelo com styling/escova fica com um brilho incr√≠vel tempor√°rio. Lembre-se de usar uma boa m√°scara na pr√≥xima lavagem para repor a √°gua perdida.`);
                        
                        if (msgs.length === 0) return `Tirou ${stats.totalSalon} dia(s) para um merecido momento nas m√£os de profissionais! O autocuidado reflete-se na sua confian√ßa.`;
                        
                        return msgs.join(" ");
                    
                    case 'extras': return "Massagens no couro cabeludo estimulam a circula√ß√£o sangu√≠nea, levando mais nutrientes √† raiz e acelerando o crescimento. Continue!";
                    default: return "Continue a acompanhar o seu Di√°rio para mais dicas.";
                }
            };

            const openModal = (type, title, icon, bgColor, iconColor, value, valColor) => {
                setActiveStatModal({ type, title, icon, bgColor, iconColor, value, valColor, insight: getInsightFor(type) });
            };

            const closeModal = () => {
                setIsClosingModal(true);
                setTimeout(() => { setActiveStatModal(null); setIsClosingModal(false); }, 350);
            };

            const currentYear = viewingMonth.getFullYear();
            const currentMonthIndex = viewingMonth.getMonth();
            const daysInMonth = new Date(currentYear, currentMonthIndex + 1, 0).getDate();
            const firstDayOfWeek = new Date(currentYear, currentMonthIndex, 1).getDay();
            const blanks = Array.from({ length: firstDayOfWeek }, (_, i) => i);
            const monthDays = Array.from({ length: daysInMonth }, (_, i) => i + 1);

            const activeProductsForDiary = products.filter(p => 
                (!p.createdAt || p.createdAt <= activeDateStr) && 
                (!p.archivedAt || p.archivedAt > activeDateStr) &&
                !(p.hiddenDates && p.hiddenDates.includes(activeDateStr))
            );

            const TabHeader = ({ titleContent, showOptions = false }) => (
                <div className="flex justify-between items-start mb-6 cascade-item" style={{animationDelay: '0ms'}}>
                    <div className="flex-1">{titleContent}</div>
                    <div className={`flex items-center gap-2 ml-4 transition-opacity ${showOptions ? 'opacity-100' : 'opacity-0 pointer-events-none'}`}>
                        {deferredPrompt && <button onClick={() => deferredPrompt.prompt()} className={`${colors.primary} ${colors.primaryText} p-3 rounded-full shadow-sm`}><i className="ph-bold ph-download-simple text-xl"></i></button>}
                        <button onClick={toggleTheme} className={`${colors.yellow} p-3 rounded-full shadow-sm`}><i className={`ph-fill ${isDarkMode ? 'ph-moon' : 'ph-sun'} ${colors.yellowText} text-xl`}></i></button>
                        <button onClick={() => setShowTutorial(true)} className={`bg-blue-100 text-blue-500 dark:bg-blue-900/30 dark:text-blue-400 p-3 rounded-full shadow-sm`}><i className="ph-bold ph-info text-xl"></i></button>
                        <button onClick={handleOpenSettings} className={`${colors.card} border ${colors.border} ${colors.textStrong} p-3 rounded-full shadow-sm`}><i className="ph-bold ph-gear text-xl"></i></button>
                    </div>
                </div>
            );

            // TELA DE AUTENTICA√á√ÉO COM CASCATA FLU√çDA
            if (authStep === 'auth' || authStep === 'onboarding' || authStep === 'recovery') {
                return (
                    <div 
                        className={`min-h-[100dvh] w-full ${colors.bg} flex items-center justify-center p-4 transition-colors overflow-hidden`}
                        onTouchStart={handlePullTouchStart}
                        onTouchMove={handlePullTouchMove}
                        onTouchEnd={handlePullTouchEnd}
                    >
                        {/* √çCONE PULL TO REFRESH */}
                        <div className={`absolute top-0 left-0 w-full flex justify-center items-center pointer-events-none transition-opacity duration-300 z-50 ${pullDistance > 20 ? 'opacity-100' : 'opacity-0'}`} style={{ transform: `translateY(${Math.min(pullDistance, 90)}px)` }}>
                            <div className={`${colors.card} rounded-full p-2.5 shadow-lg border ${colors.border}`}>
                                <i className={`ph-bold ph-arrow-down ${colors.textStrong} text-xl transition-transform duration-300 ${pullDistance > 110 ? 'rotate-180 text-blue-500' : ''}`}></i>
                            </div>
                        </div>

                        <div key={`auth-${refreshTrigger}`} className={`max-w-md w-full relative ${colors.bg} shadow-2xl flex flex-col rounded-[2.5rem] border ${colors.border}`}>
                            
                            {authStep === 'auth' && (
                                <div className="p-8 flex flex-col items-center text-center">
                                    <div className="flex w-full justify-end items-center absolute top-6 right-6 cascade-item" style={{animationDelay: '0ms'}}>
                                        <button onClick={toggleTheme} className={`${colors.yellow} p-3 rounded-full shadow-sm`}><i className={`ph-fill ${isDarkMode ? 'ph-moon' : 'ph-sun'} ${colors.yellowText} text-xl`}></i></button>
                                    </div>
                                    
                                    <div className="mt-8 cascade-item" style={{animationDelay: '120ms'}}>
                                        <div className={`w-24 h-24 mx-auto mb-4 rounded-full ${colors.primary} flex items-center justify-center`}><i className={`ph-fill ph-flower-lotus ${colors.primaryText} text-5xl block`}></i></div>
                                        <h1 className={`text-4xl font-black ${colors.text} font-serif tracking-tight`}>Meu Cabelo</h1>
                                        <p className={`text-sm ${colors.textLight} mt-2`}>O seu di√°rio de rotina e sa√∫de capilar.</p>
                                    </div>

                                    <div className="w-full space-y-4 mt-10 cascade-item" style={{animationDelay: '240ms'}}>
                                        <div className="flex w-full mb-6 p-1 bg-black/5 dark:bg-white/5 rounded-2xl">
                                            <button onClick={() => { setIsLoginFlow(true); setUsernameInput(''); setPasswordInput(''); }} className={`flex-1 py-2 rounded-xl text-sm font-bold transition-all ${isLoginFlow ? colors.card + ' shadow-sm ' + colors.textStrong : colors.textMuted}`}>Entrar</button>
                                            <button onClick={() => { setIsLoginFlow(false); setUsernameInput(''); setPasswordInput(''); }} className={`flex-1 py-2 rounded-xl text-sm font-bold transition-all ${!isLoginFlow ? colors.card + ' shadow-sm ' + colors.textStrong : colors.textMuted}`}>Registe-se</button>
                                        </div>
                                        <div className={`flex items-center ${colors.card} px-4 py-3 rounded-2xl border ${colors.border}`}>
                                            <i className={`ph-fill ph-user ${colors.textLight} text-xl`}></i><input type="text" placeholder="Utilizador" value={usernameInput} onChange={e => setUsernameInput(e.target.value)} className={`w-full ml-3 border-none outline-none bg-transparent ${colors.textStrong}`} />
                                        </div>
                                        <div className={`flex items-center ${colors.card} px-4 py-3 rounded-2xl border ${colors.border}`}>
                                            <i className={`ph-fill ph-lock-key ${colors.textLight} text-xl`}></i><input type="password" placeholder="Palavra-passe" value={passwordInput} onChange={e => setPasswordInput(e.target.value)} className={`w-full ml-3 border-none outline-none bg-transparent ${colors.textStrong}`} />
                                        </div>
                                    </div>

                                    <Button colors={colors} variant="primary" onClick={handleAuthSubmit} className="w-full py-4 mt-6 text-lg cascade-item" style={{animationDelay: '360ms'}}>
                                        {isLoginFlow ? 'Entrar no Di√°rio' : 'Criar Conta'}
                                    </Button>

                                    <div className="flex flex-col items-center gap-2 mt-4 cascade-item" style={{animationDelay: '480ms'}}>
                                        {isLoginFlow && <button onClick={() => { setAuthStep('recovery'); setUsernameInput(''); setPasswordInput(''); }} className={`text-xs font-bold ${colors.primaryText} hover:underline`}>Esqueceu a palavra-passe?</button>}
                                    </div>
                                </div>
                            )}

                            {authStep === 'onboarding' && (
                                <div className="p-8 text-center">
                                    <div className="cascade-item" style={{animationDelay: '120ms'}}>
                                        <i className={`ph-fill ph-sparkle ${colors.primaryText} text-4xl mb-4 bg-[#D2E0D9] p-4 rounded-full inline-block`}></i>
                                        <h1 className={`text-2xl font-bold ${colors.text} font-serif`}>Como devemos chamar-lhe?</h1>
                                    </div>
                                    <div className="space-y-4 mt-8 cascade-item" style={{animationDelay: '240ms'}}>
                                        <div className={`flex items-center ${colors.card} px-4 py-3 rounded-2xl border ${colors.border}`}><i className={`ph-fill ph-user ${colors.textLight} text-xl`}></i><input type="text" placeholder="O seu nome (ex: Joana)" value={userName} onChange={e => setUserName(e.target.value)} className={`w-full ml-3 border-none outline-none bg-transparent ${colors.textStrong}`} /></div>
                                        <div className="text-left pt-2 pb-1"><label className={`text-sm font-bold ${colors.textMuted} ml-2`}>Pergunta para recupera√ß√£o de senha:</label></div>
                                        <div className={`flex items-center ${colors.card} px-4 py-3 rounded-2xl border ${colors.border}`}><i className={`ph-fill ph-shield-check ${colors.textLight} text-xl`}></i><input type="text" placeholder="Qual o nome da sua av√≥?" value={securityAnswerInput} onChange={e => setSecurityAnswerInput(e.target.value)} className={`w-full ml-3 border-none outline-none bg-transparent ${colors.textStrong}`} /></div>
                                    </div>
                                    <Button colors={colors} variant="primary" onClick={handleOnboardingSubmit} className="w-full py-4 mt-8 text-lg cascade-item" style={{animationDelay: '360ms'}}>Come√ßar a Usar</Button>
                                </div>
                            )}

                            {authStep === 'recovery' && (
                                <div className="p-8 text-center">
                                    <button onClick={() => { setAuthStep('auth'); setUsernameInput(''); setSecurityAnswerInput(''); }} className={`absolute top-6 left-6 ${colors.textLight} hover:${colors.textStrong} cascade-item`} style={{animationDelay: '0ms'}}><i className="ph-bold ph-arrow-left text-xl"></i></button>
                                    
                                    <div className="cascade-item" style={{animationDelay: '120ms'}}>
                                        <i className={`ph-fill ph-lock-key ${colors.primaryText} text-4xl mb-4 mt-4 bg-[#D2E0D9] p-4 rounded-full inline-block mx-auto`}></i>
                                        <h1 className={`text-2xl font-bold ${colors.text} font-serif mb-6`}>Recuperar Palavra-passe</h1>
                                    </div>
                                    
                                    <div className="space-y-4 cascade-item" style={{animationDelay: '240ms'}}>
                                        <div className={`flex items-center ${colors.card} px-4 py-3 rounded-2xl border ${colors.border}`}><i className={`ph-fill ph-user ${colors.textLight} text-xl`}></i><input type="text" placeholder="O seu Utilizador" value={usernameInput} onChange={e => setUsernameInput(e.target.value)} className={`w-full ml-3 border-none outline-none bg-transparent ${colors.textStrong}`} /></div>
                                        <div className="text-left mt-4 mb-2"><label className={`text-sm font-bold ${colors.textMuted} ml-2`}>Responda √† pergunta de seguran√ßa:</label></div>
                                        <div className={`flex items-center ${colors.card} px-4 py-3 rounded-2xl border ${colors.border}`}><i className={`ph-fill ph-question ${colors.textLight} text-xl`}></i><input type="text" placeholder="Qual o nome da sua av√≥?" value={securityAnswerInput} onChange={e => setSecurityAnswerInput(e.target.value)} className={`w-full ml-3 border-none outline-none bg-transparent ${colors.textStrong}`} /></div>
                                    </div>

                                    <Button colors={colors} variant="primary" onClick={handleRecoverySubmit} className="w-full py-4 mt-8 text-lg cascade-item" style={{animationDelay: '360ms'}}>Recuperar</Button>
                                </div>
                            )}

                        </div>
                        <div className="absolute top-4 w-full px-4 z-50 flex flex-col gap-2 pointer-events-none max-w-md mx-auto">
                            {notifications.map(n => <div key={n.id} className={`${n.isError ? 'bg-red-500/90 border-red-600' : colors.notification} p-4 rounded-2xl flex items-center shadow-lg pointer-events-auto border animate-in`}><i className={`ph-fill ${n.isError ? 'ph-warning-circle text-white' : 'ph-info text-blue-500'} mr-2`}></i><p className={`font-bold ${n.isError ? 'text-white' : colors.textStrong} text-sm`}>{n.msg}</p></div>)}
                        </div>
                    </div>
                );
            }

            return (
                <div className={`h-[100dvh] w-full ${colors.bg} transition-colors duration-500 overflow-hidden relative`}
                     onTouchStart={handlePullTouchStart}
                     onTouchMove={handlePullTouchMove}
                     onTouchEnd={handlePullTouchEnd}
                >
                    
                    {/* √çCONE PULL TO REFRESH */}
                    <div className={`absolute top-0 left-0 w-full flex justify-center items-center pointer-events-none transition-opacity duration-300 z-50 ${pullDistance > 20 ? 'opacity-100' : 'opacity-0'}`} style={{ transform: `translateY(${Math.min(pullDistance, 90)}px)` }}>
                        <div className={`${colors.card} rounded-full p-2.5 shadow-lg border ${colors.border}`}>
                            <i className={`ph-bold ph-arrow-down ${colors.textStrong} text-xl transition-transform duration-300 ${pullDistance > 110 ? 'rotate-180 text-blue-500' : ''}`}></i>
                        </div>
                    </div>

                    {/* OVERLAY DEFINI√á√ïES (ENGRENAGEM) */}
                    {isSettingsOpen && (
                        <div className="absolute inset-0 z-[120] bg-black/70 backdrop-blur-md flex items-center justify-center p-6 perspective-container transition-opacity" onClick={handleCloseSettings}>
                            <div className={`${colors.card} w-full max-w-[340px] rounded-[2rem] p-6 shadow-2xl ${isClosingSettings ? 'flip-card-exit' : 'flip-card-enter'} border border-white/10 flex flex-col`} onClick={e => e.stopPropagation()}>
                                <div className="flex justify-between items-center mb-6">
                                    <h2 className={`text-xl font-black ${colors.text} font-serif`}><i className="ph-fill ph-gear mr-2"></i>Defini√ß√µes</h2>
                                    <button onClick={handleCloseSettings} className={`${colors.textLight} hover:${colors.textStrong}`}><i className="ph-bold ph-x text-xl"></i></button>
                                </div>
                                <div className="space-y-4 mb-8">
                                    <div>
                                        <label className={`text-xs font-bold uppercase tracking-widest ${colors.textLight} mb-2 block`}>O seu nome</label>
                                        <div className={`flex items-center ${colors.surface} px-4 py-3 rounded-2xl border ${colors.border}`}>
                                            <i className={`ph-fill ph-user ${colors.textMuted} text-lg`}></i>
                                            <input type="text" value={editNameInput} onChange={e => setEditNameInput(e.target.value)} className={`w-full ml-3 border-none outline-none bg-transparent ${colors.textStrong}`} />
                                        </div>
                                    </div>
                                    <div>
                                        <label className={`text-xs font-bold uppercase tracking-widest ${colors.textLight} mb-2 block`}>Nova Palavra-passe</label>
                                        <div className={`flex items-center ${colors.surface} px-4 py-3 rounded-2xl border ${colors.border}`}>
                                            <i className={`ph-fill ph-lock-key ${colors.textMuted} text-lg`}></i>
                                            <input type="text" value={editPasswordInput} onChange={e => setEditPasswordInput(e.target.value)} className={`w-full ml-3 border-none outline-none bg-transparent ${colors.textStrong}`} />
                                        </div>
                                    </div>
                                </div>
                                <Button onClick={handleCloseSettings} variant="primary" colors={colors} className="w-full">Guardar e Fechar</Button>
                                <button onClick={handleLogout} className="mt-4 text-sm font-bold text-red-400 hover:text-red-500 transition-colors">Sair da Conta (Logout)</button>
                            </div>
                        </div>
                    )}

                    {/* OVERLAY ESCOLHER PER√çODO PERSONALIZADO */}
                    {isCustomDateOpen && (
                        <div className="absolute inset-0 z-[120] bg-black/70 backdrop-blur-md flex items-center justify-center p-6 perspective-container transition-opacity" onClick={handleCloseCustomDate}>
                            <div className={`${colors.card} w-full max-w-[340px] rounded-[2rem] p-6 shadow-2xl ${isClosingCustomDate ? 'flip-card-exit' : 'flip-card-enter'} border border-white/10 flex flex-col`} onClick={e => e.stopPropagation()}>
                                <h2 className={`text-xl font-black ${colors.text} font-serif mb-6 text-center`}><i className="ph-fill ph-calendar mr-2"></i>Per√≠odo Personalizado</h2>
                                <div className="space-y-4 mb-8">
                                    <div>
                                        <label className={`text-xs font-bold uppercase tracking-widest ${colors.textLight} mb-2 block`}>Data de In√≠cio</label>
                                        <input type="date" value={customStart} onChange={e => setCustomStart(e.target.value)} className={`w-full ${colors.surface} px-4 py-3 rounded-2xl border ${colors.border} outline-none ${colors.textStrong}`} />
                                    </div>
                                    <div>
                                        <label className={`text-xs font-bold uppercase tracking-widest ${colors.textLight} mb-2 block`}>Data de Fim</label>
                                        <input type="date" value={customEnd} onChange={e => setCustomEnd(e.target.value)} className={`w-full ${colors.surface} px-4 py-3 rounded-2xl border ${colors.border} outline-none ${colors.textStrong}`} />
                                    </div>
                                </div>
                                <Button onClick={() => { setStatsPeriod('custom'); handleCloseCustomDate(); }} variant="primary" colors={colors} className="w-full">Aplicar</Button>
                            </div>
                        </div>
                    )}

                    {/* OVERLAY TUTORIAL (C/ OP√á√ÉO DE N√ÉO MOSTRAR) */}
                    {showTutorial && (
                        <div className="absolute inset-0 z-[120] bg-black/70 backdrop-blur-md flex items-center justify-center p-6 perspective-container transition-opacity" onClick={handleCloseTutorial}>
                            <div className={`${colors.card} w-full max-w-[340px] rounded-[2rem] p-6 shadow-2xl flip-card-enter border border-white/10 flex flex-col`} onClick={e => e.stopPropagation()}>
                                <h2 className={`text-2xl font-black ${colors.text} font-serif mb-2 text-center`}>Dicion√°rio do Fio</h2>
                                <p className={`text-xs ${colors.textMuted} text-center mb-6`}>Entenda o que cada estado significa.</p>
                                <div className="space-y-4 overflow-y-auto max-h-[50vh] pb-2 scrollbar-hide">
                                    {HAIR_STATUS.map(s => (
                                        <div key={s.id} className={`flex items-start gap-4 p-3 rounded-2xl ${colors.surface}`}>
                                            <div className={`p-2 rounded-full bg-white dark:bg-black/20 shadow-sm shrink-0`}><i className={`ph-fill ${s.icon} ${s.color} text-2xl block`}></i></div>
                                            <div>
                                                <h4 className={`font-bold ${colors.textStrong} text-sm mb-1`}>{s.label}</h4>
                                                <p className={`text-xs ${colors.textLight} leading-relaxed`}>{s.desc}</p>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                                
                                <div className="flex items-center gap-2 mt-4 mb-3 justify-center">
                                    <input type="checkbox" id="hideTutorial" checked={dontShowTutorialAgain} onChange={e => setDontShowTutorialAgain(e.target.checked)} className="w-4 h-4 accent-purple-500 rounded-md" />
                                    <label htmlFor="hideTutorial" className={`text-xs ${colors.textLight} font-bold`}>N√£o mostrar novamente neste login</label>
                                </div>

                                <Button onClick={handleCloseTutorial} variant="primary" colors={colors} className="w-full mt-2">Entendido</Button>
                            </div>
                        </div>
                    )}

                    {/* MODAL ADICIONAR PRODUTO NO PASSADO */}
                    {pastProductPrompt && (
                        <div className="absolute inset-0 z-[110] bg-black/60 backdrop-blur-sm flex items-center justify-center p-6 transition-opacity">
                            <div className={`${colors.card} w-full max-w-[320px] rounded-[2rem] p-6 shadow-2xl animate-in border ${colors.border} flex flex-col text-center`}>
                                <div className={`w-16 h-16 mx-auto bg-blue-100 dark:bg-blue-900/30 rounded-full flex items-center justify-center mb-4`}>
                                    <i className={`ph-fill ph-calendar-plus text-blue-500 text-3xl`}></i>
                                </div>
                                <h2 className={`text-xl font-bold ${colors.text} font-serif mb-2`}>Produto no Passado</h2>
                                <p className={`text-sm ${colors.textLight} mb-6`}>Est√° a adicionar <b>{pastProductPrompt.name}</b> numa data passada. Como deseja aplicar nos dias seguintes at√© hoje?</p>
                                
                                <div className="flex flex-col gap-2">
                                    <button onClick={() => handlePastProductDecision('CHECK_ALL')} className={`p-3 rounded-xl bg-blue-500 text-white font-bold text-sm hover:bg-blue-600 shadow-sm transition-colors`}>
                                        Adicionar e marcar como usado at√© hoje
                                    </button>
                                    <button onClick={() => handlePastProductDecision('ADD_ONLY')} className={`p-3 rounded-xl ${colors.surfaceAlt} ${colors.textStrong} font-bold text-sm hover:brightness-95 transition-colors`}>
                                        Apenas mostrar na lista
                                    </button>
                                    <button onClick={() => handlePastProductDecision('SINGLE_USE')} className={`p-3 rounded-xl border border-red-200 text-red-500 bg-red-50 dark:bg-red-900/10 font-bold text-sm hover:bg-red-100 transition-colors`}>
                                        Foi uso √∫nico (apenas neste dia)
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* MODAL DE INSIGHT FLIP */}
                    {activeStatModal && (
                        <div className="absolute inset-0 z-[100] flex items-center justify-center p-6 bg-black/40 backdrop-blur-sm transition-opacity perspective-container" onClick={closeModal}>
                            <div className={`w-full max-w-[320px] ${colors.card} rounded-[2.5rem] p-8 shadow-2xl border ${colors.border} ${isClosingModal ? 'flip-card-exit' : 'flip-card-enter'} flex flex-col items-center text-center`} onClick={e => e.stopPropagation()}>
                                <button onClick={closeModal} className={`absolute top-5 right-5 ${colors.textLight} hover:${colors.textStrong} p-1`}><i className="ph-bold ph-x text-xl"></i></button>
                                <div className={`p-5 rounded-full ${activeStatModal.bgColor} mb-4`}>
                                    <i className={`ph-fill ${activeStatModal.icon} ${activeStatModal.iconColor} text-5xl`}></i>
                                </div>
                                <h2 className={`text-2xl font-bold ${colors.text} font-serif mb-1`}>{activeStatModal.title}</h2>
                                <p className={`text-4xl font-black ${activeStatModal.valColor} mb-6`}>{activeStatModal.value}</p>
                                <div className={`${colors.surface} p-4 rounded-3xl border ${colors.border} w-full shadow-inner`}>
                                    <p className={`text-sm font-medium ${colors.textStrong} leading-relaxed`}>{activeStatModal.insight}</p>
                                </div>
                            </div>
                        </div>
                    )}

                    <div className="absolute top-4 w-full px-4 z-50 flex flex-col gap-2 pointer-events-none max-w-md mx-auto left-1/2 -translate-x-1/2">
                        {notifications.map(n => (
                            <div key={n.id} className={`${n.isError ? 'bg-red-500/90 border-red-600' : colors.notification} p-4 rounded-2xl flex items-center shadow-lg pointer-events-auto border animate-in`}><i className={`ph-fill ${n.isError ? 'ph-warning-circle text-white' : 'ph-check-circle text-green-500'} mr-2 text-xl`}></i><p className={`font-bold ${n.isError ? 'text-white' : colors.textStrong} text-sm`}>{n.msg}</p></div>
                        ))}
                    </div>

                    <div className={`max-w-md mx-auto h-full relative ${colors.bg} flex flex-col overflow-hidden`}>
                        <div className="flex-1 w-full relative overflow-hidden">
                            <div 
                                className="w-[300%] h-full flex flex-nowrap transition-transform duration-[400ms] ease-[cubic-bezier(0.32,0.72,0,1)]"
                                style={{ transform: `translateX(-${activeIndex * (100 / 3)}%)` }}
                            >
                                
                                {/* --- ABA: HOJE (DI√ÅRIO CAPILAR) --- */}
                                <div className="w-1/3 h-full overflow-y-auto smooth-scroll p-6 scrollbar-hide pb-40">
                                    <div key={`home-${refreshTrigger}`} className="pb-8">
                                        <TabHeader 
                                            showOptions={activeIndex === 0}
                                            titleContent={
                                                <>
                                                    <p className={`text-xs ${colors.textLight} uppercase tracking-widest font-bold`}>{formatDateVisual(activeDateStr)}</p>
                                                    <div className="mt-1 flex items-center">
                                                        <h1 className={`text-3xl font-bold ${colors.text} font-serif flex items-center gap-2 tracking-tight`}>
                                                            {activeDateStr === realTodayStr ? (
                                                                <>Ol√°, {userName}!</>
                                                            ) : 'Registo Antigo'}
                                                        </h1>
                                                    </div>
                                                    {activeDateStr !== realTodayStr && (
                                                        <button onClick={() => setActiveDateStr(realTodayStr)} className={`text-xs ${colors.primaryText} font-bold mt-2 flex items-center gap-1 bg-[#D2E0D9] bg-opacity-30 px-3 py-1.5 rounded-full inline-flex`}><i className="ph-bold ph-arrow-left"></i> Voltar para Hoje</button>
                                                    )}
                                                </>
                                            }
                                        />
                                        
                                        <div className="space-y-6">
                                            {/* CARD 1: ESTADO DO CABELO */}
                                            <Card style={{animationDelay: '120ms'}} colors={colors} className="cascade-item relative z-0">
                                                <div className="flex items-center justify-between mb-4">
                                                    <div className="flex items-center gap-2"><i className={`ph-fill ph-sparkle ${colors.accentText} text-xl`}></i><h3 className={`font-semibold ${colors.text}`}>Como sente os fios hoje?</h3></div>
                                                    <button onClick={() => setShowTutorial(true)} className={`p-1.5 rounded-full ${colors.surfaceAlt} text-sm ${colors.textMuted} hover:${colors.textStrong}`}><i className="ph-bold ph-question"></i></button>
                                                </div>
                                                
                                                <div className="relative">
                                                    {statusFeedback && (
                                                        <div className="absolute -top-12 left-1/2 -translate-x-1/2 z-[100] px-4 py-1.5 bg-[#282624] text-[#D6D0C4] dark:bg-stone-200 dark:text-stone-800 text-xs font-bold rounded-full shadow-lg toast-enter pointer-events-none whitespace-nowrap">
                                                            {statusFeedback}
                                                        </div>
                                                    )}
                                                    <div className={`flex flex-wrap justify-center gap-x-4 gap-y-3 ${colors.surface} p-4 rounded-2xl mb-4`}>
                                                        {HAIR_STATUS.map(s => (
                                                            <button type="button" key={s.id} onClick={() => handleStatusSelect(s)} className={`hover:scale-125 transition-transform ${s.color}`}>
                                                                <i className={`ph-fill ${s.icon} text-3xl`}></i>
                                                            </button>
                                                        ))}
                                                    </div>
                                                </div>

                                                {dayLog.status.length > 0 && (
                                                    <div className="flex flex-wrap gap-2">
                                                        {dayLog.status.map((s, i) => {
                                                            const statusData = HAIR_STATUS.find(x => x.id === s.status);
                                                            return (
                                                                <div key={i} className={`flex items-center gap-1 ${colors.surfaceAlt} px-3 py-1.5 rounded-full text-sm`}><i className={`ph-fill ${statusData.icon} ${statusData.color}`}></i><span className={`font-medium ${colors.textLight}`}>{s.time}</span><button onClick={() => updateActiveLog('status', dayLog.status.filter((_, idx) => idx !== i))} className="ml-1 text-red-400"><i className="ph-bold ph-x text-xs"></i></button></div>
                                                            );
                                                        })}
                                                    </div>
                                                )}
                                            </Card>

                                            {/* NOVO CHECK: LAVAGEM DO CABELO */}
                                            <Card style={{animationDelay: '240ms'}} colors={colors} className={`cascade-item py-4 flex justify-between items-center cursor-pointer transition-colors ${dayLog.washed ? 'bg-blue-50 dark:bg-blue-900/10 border-blue-200 dark:border-blue-900/50' : ''}`} onClick={() => updateActiveLog('washed', !dayLog.washed)}>
                                                <div className="flex items-center gap-3">
                                                    <div className={`p-2 rounded-full transition-colors ${dayLog.washed ? 'bg-blue-500 text-white shadow-md' : colors.surfaceAlt + ' ' + colors.textLight}`}>
                                                        <i className="ph-fill ph-drop text-xl"></i>
                                                    </div>
                                                    <span className={`font-bold transition-colors ${dayLog.washed ? 'text-blue-600 dark:text-blue-400' : colors.text}`}>Lavou a cabe√ßa neste dia?</span>
                                                </div>
                                                <div className={`w-6 h-6 rounded-md flex items-center justify-center border-2 transition-colors ${dayLog.washed ? 'bg-blue-500 border-blue-500 text-white shadow-sm' : colors.border + ' bg-transparent'}`}>
                                                    {dayLog.washed && <i className="ph-bold ph-check"></i>}
                                                </div>
                                            </Card>

                                            {/* CARD 2: PRODUTOS DI√ÅRIOS */}
                                            <Card style={{animationDelay: '360ms'}} colors={colors} className="cascade-item">
                                                <div className="flex items-center justify-between mb-4"><div className="flex items-center gap-2"><i className={`ph-fill ph-flask ${colors.blueText} text-xl`}></i><h3 className={`font-semibold ${colors.text}`}>Uso Di√°rio</h3></div><button onClick={() => setIsAddingProduct(!isAddingProduct)} className={`p-1.5 rounded-full ${colors.blue} ${colors.blueText}`}><i className={`ph-bold ${isAddingProduct ? 'ph-x' : 'ph-plus'} text-lg`}></i></button></div>
                                                {isAddingProduct && (
                                                    <div className={`${colors.blueCard} p-4 rounded-2xl mb-4 space-y-3 border`}>
                                                        <div className="flex gap-2">
                                                            <input placeholder="T√≥nico, √ìleo..." value={newProductInput.name} onChange={e => setNewProductInput({...newProductInput, name: e.target.value})} className={`flex-1 min-w-0 px-4 py-2 rounded-xl text-sm ${colors.input}`} />
                                                            <input type="time" value={newProductInput.time} onChange={e => setNewProductInput({...newProductInput, time: e.target.value})} className={`w-24 shrink-0 px-2 py-2 text-center rounded-xl text-sm ${colors.input}`} />
                                                        </div>
                                                        <Button type="button" colors={colors} variant="blue" onClick={handleAddProduct} className="w-full py-2">Guardar Produto</Button>
                                                    </div>
                                                )}
                                                <div className="space-y-3">
                                                    {activeProductsForDiary.length === 0 && !isAddingProduct && <p className={`text-xs ${colors.textMuted} text-center py-2`}>Nenhum produto di√°rio ativo neste dia.</p>}
                                                    {activeProductsForDiary.map(prod => {
                                                        const isUsed = dayLog.routine?.[prod.id];
                                                        return (
                                                            <div key={prod.id} className={`flex items-center justify-between p-3 rounded-2xl border ${isUsed ? `${colors.primary} border-transparent` : `${colors.surface} ${colors.border}`}`}>
                                                                <div className="flex items-center gap-3"><div className={`p-2 rounded-full ${isUsed ? `${colors.translucent} ${colors.primaryText}` : `${colors.card} ${colors.iconMuted}`}`}><i className="ph-fill ph-flask text-lg"></i></div><div><p className={`font-bold ${isUsed ? colors.primaryText : colors.textStrong} text-sm`}>{prod.name}</p><p className={`text-xs ${isUsed ? colors.primaryText : colors.textLight}`}>{prod.time}</p></div></div>
                                                                <div className="flex gap-2">
                                                                    <button onClick={() => handleRemoveProduct(prod.id)} className="text-red-400 p-2"><i className="ph-bold ph-x text-sm"></i></button>
                                                                    <button onClick={() => { const r = {...(dayLog.routine || {})}; r[prod.id] = !r[prod.id]; updateActiveLog('routine', r); }} className={`w-10 h-10 rounded-full flex items-center justify-center border-2 ${isUsed ? `${colors.card} ${colors.primaryText} border-transparent` : `${colors.border} text-transparent`}`}><i className="ph-bold ph-check text-xl"></i></button>
                                                                </div>
                                                            </div>
                                                        )
                                                    })}
                                                </div>
                                            </Card>

                                            {/* CARD 3: M√ÅSCARA / TRATAMENTO COM DESFAZER */}
                                            <Card style={{animationDelay: '480ms'}} colors={colors} className="cascade-item">
                                                <div className="flex items-center gap-2 mb-4"><i className="ph-fill ph-magic-wand text-emerald-500 text-xl"></i><h3 className={`font-semibold ${colors.text}`}>Cronograma Capilar</h3></div>
                                                <div className="space-y-4">
                                                    <div>
                                                        <label className={`text-sm ${colors.textLight} mb-2 block`}>Tempo de M√°scara: <span className={`font-bold ${colors.emeraldText}`}>{dayLog.treatment?.minutes || 0} min</span></label>
                                                        <input type="range" min="0" max="60" step="5" value={dayLog.treatment?.minutes || 0} onChange={(e) => updateActiveLog('treatment', { minutes: parseInt(e.target.value), type: dayLog.treatment?.type })} className="w-full accent-emerald-500" />
                                                    </div>
                                                    <div className="grid grid-cols-2 gap-2">
                                                        {TREATMENT_TYPES.map(q => (
                                                            <button 
                                                                type="button" 
                                                                key={q.id} 
                                                                onClick={() => updateActiveLog('treatment', { minutes: dayLog.treatment?.minutes || 0, type: dayLog.treatment?.type === q.id ? '' : q.id })} 
                                                                className={`w-full py-2.5 rounded-xl text-xs font-bold border transition-all ${dayLog.treatment?.type === q.id ? 'bg-emerald-500/20 text-emerald-600 border-emerald-200' : `${colors.surface} ${colors.text} border-transparent`}`}
                                                            >
                                                                {q.label}
                                                            </button>
                                                        ))}
                                                    </div>
                                                </div>
                                            </Card>

                                            {/* CARD 4: FONTES DE CALOR */}
                                            <Card style={{animationDelay: '600ms'}} colors={colors} className={`cascade-item flex flex-col gap-4 ${colors.orange} bg-opacity-20 border-orange-200`}>
                                                <div className="flex items-center gap-2"><i className="ph-fill ph-fire text-orange-500 text-xl"></i><h3 className={`font-semibold ${colors.textStrong}`}>Uso de Calor</h3></div>
                                                
                                                <div className="flex flex-col gap-2">
                                                    <button type="button" onClick={() => updateActiveLog('heat', { ...dayLog.heat, active: !dayLog.heat.active })} className={`flex items-center justify-between p-3.5 rounded-xl border-2 transition-all ${dayLog.heat.active ? 'border-orange-400 bg-orange-100/50 dark:bg-orange-900/30' : 'border-transparent ' + colors.surface}`}>
                                                        <span className={`text-sm font-bold ${dayLog.heat.active ? colors.orangeText : colors.text}`}>Usei Secador / Chapinha</span>
                                                        <div className={`w-6 h-6 rounded-md flex items-center justify-center border transition-colors ${dayLog.heat.active ? 'bg-orange-500 border-orange-500 text-white shadow-sm' : colors.border + ' bg-transparent'}`}>
                                                            {dayLog.heat.active && <i className="ph-bold ph-check"></i>}
                                                        </div>
                                                    </button>

                                                    {dayLog.heat.active && (
                                                        <button type="button" onClick={() => updateActiveLog('heat', { ...dayLog.heat, protectant: !dayLog.heat.protectant })} className={`flex items-center justify-between p-3.5 rounded-xl border-2 transition-all animate-in ${dayLog.heat.protectant ? 'border-green-400 bg-green-100/50 dark:bg-green-900/30' : 'border-red-200 bg-red-50/50 dark:bg-red-900/20'}`}>
                                                            <span className={`text-sm font-bold ${dayLog.heat.protectant ? 'text-green-600' : 'text-red-400'}`}>Apliquei Protetor T√©rmico</span>
                                                            <div className={`w-6 h-6 rounded-md flex items-center justify-center border transition-colors ${dayLog.heat.protectant ? 'bg-green-500 border-green-500 text-white shadow-sm' : 'border-red-300 bg-transparent'}`}>
                                                                {dayLog.heat.protectant && <i className="ph-bold ph-check"></i>}
                                                            </div>
                                                        </button>
                                                    )}
                                                </div>
                                            </Card>

                                            {/* CARD 5: SAL√ÉO */}
                                            <Card style={{animationDelay: '720ms'}} colors={colors} className={`cascade-item ${colors.purple} bg-opacity-20`}>
                                                <div className="flex items-center gap-2 mb-4"><i className={`ph-fill ph-scissors ${colors.purpleText} text-xl`}></i><h3 className={`font-semibold ${colors.text}`}>Ida ao Sal√£o</h3></div>
                                                {dayLog.salon ? (
                                                    <div className={`${colors.translucentStrong} p-4 rounded-xl shadow-sm`}>
                                                        <div className="mb-3">
                                                            <p className={`text-xs ${colors.textMuted} uppercase font-bold mb-2`}>O que fez</p>
                                                            <div className="flex flex-col gap-2">
                                                                {(Array.isArray(dayLog.salon.procedures) ? dayLog.salon.procedures : (dayLog.salon.procedures || '').split(', ').filter(Boolean)).map((p, idx) => (
                                                                    <div key={idx} className={`p-2 rounded-xl border border-purple-200 dark:border-purple-800 bg-purple-50 dark:bg-purple-900/30`}>
                                                                        <p className={`text-xs font-bold ${colors.purpleText}`}>{p}</p>
                                                                        {SALON_INFO[p] && <p className={`text-[10px] ${colors.textStrong} opacity-80 mt-1`}>{SALON_INFO[p]}</p>}
                                                                    </div>
                                                                ))}
                                                            </div>
                                                        </div>
                                                        <div className="flex justify-between items-center border-t border-purple-200/50 pt-3 mt-1">
                                                            <span className={`${HAIR_STATUS.find(m => m.id === dayLog.salon.mood)?.color} flex items-center gap-1 text-sm font-bold`}><i className={`ph-fill ${HAIR_STATUS.find(m => m.id === dayLog.salon.mood)?.icon} text-xl`}></i> Resultado</span>
                                                            <div className="flex gap-3">
                                                                <button onClick={handleEditSalon} className="text-blue-500 text-sm flex items-center gap-1"><i className="ph-bold ph-pencil-simple"></i></button>
                                                                <button onClick={() => updateActiveLog('salon', null)} className="text-red-400 text-sm flex items-center gap-1"><i className="ph-bold ph-trash"></i></button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                ) : (
                                                    <div className="space-y-4">
                                                        <div>
                                                            <p className={`text-xs ${colors.textMuted} mb-3 block font-bold text-center`}>Toque nos bot√µes do que fez hoje no sal√£o:</p>
                                                            <div className="flex flex-wrap gap-2 justify-center mb-4">
                                                                {Object.keys(SALON_INFO).map(p => {
                                                                    const isSelected = salonInput.procedures.includes(p);
                                                                    return (
                                                                        <button type="button" key={p} onClick={() => toggleSalonProcedure(p)} className={`text-[11px] font-bold px-3 py-2 rounded-xl shadow-sm border transition-all ${isSelected ? 'bg-purple-500 text-white border-purple-500 scale-105' : `${colors.surface} ${colors.textStrong} border-stone-200 dark:border-stone-700 hover:bg-purple-50 dark:hover:bg-purple-900/20`}`}>
                                                                            {isSelected ? '‚úì ' : '+ '}{p}
                                                                        </button>
                                                                    )
                                                                })}
                                                            </div>

                                                            {salonInput.procedures.length > 0 && (
                                                                <div className="flex flex-col gap-2 mb-4 animate-in">
                                                                    <p className={`text-[10px] uppercase font-bold ${colors.purpleText} ml-1`}>Dicas sobre as suas escolhas:</p>
                                                                    {salonInput.procedures.map((p, idx) => (
                                                                        <div key={idx} className={`p-2.5 rounded-xl border border-purple-200 dark:border-purple-800 bg-white/60 dark:bg-black/20 flex gap-2 items-start`}>
                                                                            <i className={`ph-fill ph-info text-purple-400 mt-0.5`}></i>
                                                                            <div>
                                                                                <span className={`text-[11px] font-bold ${colors.textStrong} block leading-none mb-1`}>{p}</span>
                                                                                <span className={`text-[10px] ${colors.textMuted}`}>{SALON_INFO[p]}</span>
                                                                            </div>
                                                                        </div>
                                                                    ))}
                                                                </div>
                                                            )}
                                                        </div>
                                                        <div>
                                                            <label className={`text-xs ${colors.textMuted} mb-2 block text-center font-bold`}>Como se sentiu com o resultado final?</label>
                                                            <div className={`flex justify-between items-center ${colors.card} p-2 rounded-xl overflow-x-auto gap-2`}>{HAIR_STATUS.map(m => (<button type="button" key={m.id} onClick={() => setSalonInput({...salonInput, mood: m.id})} className={`p-1.5 shrink-0 rounded-full transition-all ${salonInput.mood === m.id ? `${colors.surface} shadow-sm ${m.color} scale-110` : 'opacity-40 grayscale hover:grayscale-0'}`}><i className={`ph-fill ${m.icon} text-3xl`}></i></button>))}</div>
                                                        </div>
                                                        <Button type="button" colors={colors} variant="purple" onClick={() => { if (salonInput.procedures.length > 0) { updateActiveLog('salon', salonInput); setSalonInput({ procedures: [], mood: 'perfeito' }); } else { addNotification("Adicione pelo menos um procedimento!"); } }} className="w-full py-3 shadow-sm">Guardar Ida ao Sal√£o</Button>
                                                    </div>
                                                )}
                                            </Card>

                                            {/* CARD 6: EXTRAS */}
                                            <Card style={{animationDelay: '840ms'}} colors={colors} className={`cascade-item ${colors.teal} bg-opacity-20 p-5`}>
                                                <div className="flex items-center gap-2 mb-4"><i className={`ph-fill ph-hand-heart ${colors.tealText} text-xl`}></i><h3 className={`font-semibold ${colors.text}`}>Cuidados Extras</h3></div>
                                                <div className="flex gap-2 mb-4"><input placeholder="Ex: Massagem Capilar" value={extraInput.type} onChange={e => setExtraInput({...extraInput, type: e.target.value})} className={`flex-1 min-w-0 p-2 rounded-lg ${colors.input}`} /><input type="number" placeholder="Min" value={extraInput.duration} onChange={e => setExtraInput({...extraInput, duration: e.target.value})} className={`w-16 shrink-0 p-2 rounded-lg text-center ${colors.input}`} /><button type="button" onClick={() => { if(extraInput.type && extraInput.duration) { updateActiveLog('extras', [...dayLog.extras, {type: extraInput.type, duration: parseInt(extraInput.duration)}]); setExtraInput({type:'',duration:''}); } }} className={`${colors.teal} ${colors.tealText} px-3 rounded-lg font-bold shrink-0`}><i className="ph-bold ph-plus"></i></button></div>
                                                {dayLog.extras?.map((ex, i) => (<div key={i} className={`flex justify-between items-center ${colors.translucentStrong} p-2 rounded-lg text-sm mt-2`}><span className={colors.textStrong}>{ex.type}</span><div className="flex items-center gap-3"><span className={`text-xs ${colors.textMuted}`}>{ex.duration}m</span><button type="button" onClick={() => updateActiveLog('extras', dayLog.extras.filter((_, idx) => idx !== i))} className="text-red-400 shrink-0"><i className="ph-bold ph-x"></i></button></div></div>))}
                                            </Card>
                                        </div>
                                    </div>
                                </div>

                                {/* --- ABA: HIST√ìRICO --- */}
                                <div className="w-1/3 h-full overflow-y-auto smooth-scroll p-6 scrollbar-hide pb-40">
                                    <div key={`hist-${refreshTrigger}`} className="pb-8">
                                        <TabHeader 
                                            showOptions={activeIndex === 1}
                                            titleContent={<h1 className={`text-3xl font-bold ${colors.text} font-serif mt-1 tracking-tight cascade-item`} style={{animationDelay: '0ms'}}>Hist√≥rico</h1>}
                                        />
                                        <div className="space-y-6">
                                            <Card style={{animationDelay: '120ms'}} colors={colors} className="cascade-item p-4 cursor-default">
                                                <div className="flex justify-between items-center mb-6">
                                                    <button onClick={() => setViewingMonth(new Date(currentYear, currentMonthIndex - 1, 1))} className={`p-2 ${colors.surface} rounded-full`}><i className="ph-bold ph-caret-left"></i></button>
                                                    <h2 className={`font-bold ${colors.textStrong}`}>{MONTHS[currentMonthIndex]} {currentYear}</h2>
                                                    <button onClick={() => setViewingMonth(new Date(currentYear, currentMonthIndex + 1, 1))} className={`p-2 ${colors.surface} rounded-full`}><i className="ph-bold ph-caret-right"></i></button>
                                                </div>
                                                <div className="grid grid-cols-7 gap-y-2 text-center">
                                                    {WEEKDAYS.map(day => <div key={day} className={`text-xs font-bold ${colors.textLight} py-2`}>{day}</div>)}
                                                    {blanks.map(blank => <div key={`blank-${blank}`} className="w-8 h-8"></div>)}
                                                    {monthDays.map(day => {
                                                        const dateStr = `${currentYear}-${String(currentMonthIndex + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                                                        const dayData = logs[dateStr];
                                                        const hasData = dayData && (dayData.washed || dayData.status?.length>0 || dayData.treatment?.minutes>0 || dayData.salon || dayData.heat?.active || dayData.extras?.length>0 || Object.keys(dayData.routine||{}).length>0);
                                                        const isSel = selectedHistoryDate === dateStr;
                                                        return (
                                                            <button key={day} onClick={() => setSelectedHistoryDate(dateStr)} className={`w-8 h-8 mx-auto flex flex-col items-center justify-center rounded-xl font-bold text-sm transition-all relative ${isSel ? `${colors.primary} ${colors.primaryText} shadow-md` : `${colors.text} hover:${colors.surfaceHover}`}`}>
                                                                {day}
                                                                {hasData && (
                                                                    <div className="flex gap-0.5 mt-0.5">
                                                                        <span className={`w-1 h-1 rounded-full ${isSel ? 'bg-[#4A6B5D]' : 'bg-stone-300'}`}></span>
                                                                        {dayData.washed && <span className={`w-1 h-1 rounded-full ${isSel ? 'bg-blue-600' : 'bg-blue-400'}`}></span>}
                                                                    </div>
                                                                )}
                                                            </button>
                                                        )
                                                    })}
                                                </div>
                                            </Card>

                                            <div className="cascade-item mt-8 mb-8" style={{animationDelay: '240ms'}}>
                                                <h3 className={`text-lg font-bold ${colors.text} mb-4 flex justify-between items-center`}>
                                                    <span><i className="ph-fill ph-calendar"></i> {formatDateVisual(selectedHistoryDate)}</span>
                                                </h3>
                                                
                                                {logs[selectedHistoryDate] && (logs[selectedHistoryDate].washed || logs[selectedHistoryDate].status?.length>0 || logs[selectedHistoryDate].treatment?.minutes>0 || logs[selectedHistoryDate].salon || logs[selectedHistoryDate].heat?.active || logs[selectedHistoryDate].extras?.length>0 || Object.keys(logs[selectedHistoryDate].routine||{}).length>0) ? (
                                                    <div className="space-y-4">
                                                        <div className="grid grid-cols-2 gap-3">
                                                            {logs[selectedHistoryDate].status?.length > 0 && (
                                                                <Card colors={colors} className={`col-span-2 p-4 ${colors.surface} cascade-item`} style={{animationDelay: '360ms'}}>
                                                                    <div className="flex gap-2 flex-wrap">{logs[selectedHistoryDate].status.map((m, i) => <div key={i} className={`flex items-center gap-1 ${colors.card} px-3 py-1 rounded-full text-xs shadow-sm border ${colors.border}`}><i className={`ph-fill ${HAIR_STATUS.find(x=>x.id===m.status)?.icon} ${HAIR_STATUS.find(x=>x.id===m.status)?.color}`}></i> <span className={`font-medium ${colors.textStrong}`}>{m.time}</span></div>)}</div>
                                                                </Card>
                                                            )}
                                                            {logs[selectedHistoryDate].washed && (
                                                                <Card colors={colors} className={`col-span-2 p-3 bg-blue-50 dark:bg-blue-900/10 border-blue-200 dark:border-blue-900/50 flex items-center gap-2 cascade-item`} style={{animationDelay: '480ms'}}>
                                                                    <i className="ph-fill ph-drop text-blue-500 text-lg"></i>
                                                                    <span className="text-sm font-bold text-blue-600 dark:text-blue-400">Lavou a cabe√ßa neste dia</span>
                                                                </Card>
                                                            )}
                                                            {logs[selectedHistoryDate].salon && (
                                                                <Card colors={colors} className={`col-span-2 p-4 ${colors.purpleCard} cascade-item`} style={{animationDelay: '600ms'}}>
                                                                    <div className="flex justify-between items-center">
                                                                        <div>
                                                                            <p className={`text-xs ${colors.purpleText} font-bold mb-1.5`}><i className="ph-fill ph-scissors"></i> Sal√£o</p>
                                                                            <div className="flex flex-wrap gap-1 mt-1">
                                                                                {(Array.isArray(logs[selectedHistoryDate].salon.procedures) ? logs[selectedHistoryDate].salon.procedures : (logs[selectedHistoryDate].salon.procedures || '').split(', ')).map((p, idx) => (
                                                                                    <span key={idx} className={`text-[10px] font-bold px-2.5 py-1 rounded-md border border-purple-200 dark:border-purple-800 bg-white/50 dark:bg-black/20 ${colors.purpleText}`}>{p}</span>
                                                                                ))}
                                                                            </div>
                                                                        </div>
                                                                        <i className={`ph-fill ${HAIR_STATUS.find(m => m.id === logs[selectedHistoryDate].salon.mood)?.icon} ${HAIR_STATUS.find(m => m.id === logs[selectedHistoryDate].salon.mood)?.color} text-4xl shrink-0 ml-2`}></i>
                                                                    </div>
                                                                </Card>
                                                            )}
                                                            {(() => {
                                                                const activeProdsHistory = products.filter(p => (!p.createdAt || p.createdAt <= selectedHistoryDate) && (!p.archivedAt || p.archivedAt > selectedHistoryDate) && !(p.hiddenDates && p.hiddenDates.includes(selectedHistoryDate)));
                                                                if (activeProdsHistory.length > 0) {
                                                                    return (
                                                                        <Card colors={colors} className={`col-span-2 p-4 ${colors.blueCard} cascade-item`} style={{animationDelay: '720ms'}}>
                                                                            <p className={`text-xs ${colors.blueTextAlt} font-bold`}><i className="ph-fill ph-drop"></i> Rotina Di√°ria</p>
                                                                            <div className="mt-2 space-y-1">{activeProdsHistory.map(prod => { const taken = logs[selectedHistoryDate].routine?.[prod.id]; return <p key={prod.id} className={`text-xs ${taken ? colors.textStrong + ' font-medium' : colors.textMuted + ' line-through'}`}>{taken ? '‚úÖ' : '‚ùå'} {prod.name}</p> })}</div>
                                                                        </Card>
                                                                    )
                                                                }
                                                                return null;
                                                            })()}
                                                            {logs[selectedHistoryDate].treatment?.minutes > 0 && (
                                                                <Card colors={colors} className={`p-4 ${colors.emerald} bg-opacity-20 cascade-item`} style={{animationDelay: '840ms'}}>
                                                                    <p className={`text-xs ${colors.emeraldText} font-bold`}><i className="ph-fill ph-magic-wand"></i> M√°scara</p>
                                                                    <p className={`font-bold ${colors.emeraldText} text-lg mt-1`}>{logs[selectedHistoryDate].treatment.minutes}m</p>
                                                                    <p className={`text-xs font-bold ${colors.emeraldText} opacity-70`}>{TREATMENT_TYPES.find(t=>t.id === logs[selectedHistoryDate].treatment.type)?.label}</p>
                                                                </Card>
                                                            )}
                                                            {(logs[selectedHistoryDate].heat?.active) && (
                                                                <Card colors={colors} className={`p-4 flex flex-col justify-center ${colors.orange} bg-opacity-20 cascade-item`} style={{animationDelay: '960ms'}}>
                                                                    <p className={`text-xs ${colors.orangeText} font-bold flex items-center gap-1`}><i className="ph-fill ph-fire text-sm"></i> Calor</p>
                                                                    <p className={`font-bold ${colors.textStrong} text-sm mt-1`}>Secador/Chapinha</p>
                                                                    <p className={`text-[10px] font-bold mt-1 ${logs[selectedHistoryDate].heat.protectant ? 'text-green-600' : 'text-red-500'}`}>
                                                                        {logs[selectedHistoryDate].heat.protectant ? '‚úÖ Com prote√ß√£o' : '‚ùå Sem prote√ß√£o'}
                                                                    </p>
                                                                </Card>
                                                            )}
                                                            {logs[selectedHistoryDate].extras?.length > 0 && (
                                                                <Card colors={colors} className={`col-span-1 p-4 ${colors.teal} bg-opacity-20 cascade-item`} style={{animationDelay: '1080ms'}}>
                                                                    <p className={`text-xs ${colors.tealText} font-bold`}><i className="ph-fill ph-hand-heart"></i> Extras</p><div className="mt-2 space-y-1">{logs[selectedHistoryDate].extras.map((c,i) => <p key={i} className={`text-sm font-medium ${colors.textStrong}`}>{c.type} <span className={`text-xs font-normal ${colors.textMuted}`}>({c.duration}m)</span></p>)}</div>
                                                                </Card>
                                                            )}
                                                        </div>
                                                        <Button type="button" colors={colors} variant="outline" onClick={() => { handleNavMenuClick('home'); setActiveDateStr(selectedHistoryDate); }} className="w-full mt-4 text-sm border-2 cascade-item" style={{animationDelay: '1200ms'}}>
                                                            <i className="ph-bold ph-pencil-simple"></i> Editar este dia
                                                        </Button>
                                                    </div>
                                                ) : (
                                                    <div className="text-center py-8 cascade-item" style={{animationDelay: '360ms'}}>
                                                        <p className={`text-sm ${colors.textMuted} mb-4`}>Nenhum cuidado capilar registado.</p>
                                                        <Button type="button" colors={colors} variant="primary" onClick={() => { handleNavMenuClick('home'); setActiveDateStr(selectedHistoryDate); }} className="mx-auto text-sm">
                                                            <i className="ph-bold ph-plus"></i> Criar registo
                                                        </Button>
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                </div>


                                {/* --- ABA: ESTAT√çSTICAS / RESUMO --- */}
                                <div className="w-1/3 h-full overflow-y-auto smooth-scroll p-6 scrollbar-hide pb-40">
                                    <div key={`stats-${refreshTrigger}`} className="pb-8">
                                        <TabHeader 
                                            showOptions={activeIndex === 2}
                                            titleContent={<h1 className={`text-3xl font-bold ${colors.text} font-serif mt-1 cascade-item`} style={{animationDelay: '0ms'}}>O Meu Cabelo</h1>}
                                        />
                                        <div className="space-y-6">
                                            <div className="cascade-item flex gap-2 overflow-x-auto pb-2 scrollbar-hide smooth-scroll" style={{animationDelay: '120ms'}}>
                                                {STAT_PERIODS.map(period => (
                                                    <button 
                                                        key={period.val} 
                                                        onClick={() => {
                                                            if (period.val === 'custom') setIsCustomDateOpen(true);
                                                            else setStatsPeriod(period.val);
                                                        }} 
                                                        className={`px-4 py-2 rounded-full text-sm font-bold flex items-center gap-1.5 whitespace-nowrap ${statsPeriod === period.val ? `${colors.primary} ${colors.primaryText}` : `${colors.card} ${colors.textLight} border ${colors.border}`}`}
                                                    >
                                                        {period.icon && <i className={`ph-bold ${period.icon}`}></i>}
                                                        {period.label}
                                                    </button>
                                                ))}
                                            </div>
                                            
                                            {statsPeriod === 'custom' && (
                                                <div className="cascade-item flex justify-between items-center px-4 py-2 bg-black/5 dark:bg-white/5 rounded-full text-xs font-bold text-stone-500 mb-2" style={{animationDelay: '180ms'}}>
                                                    <span>De: {formatDateVisual(customStart).split(' de ')[0] + '/' + (new Date(customStart).getMonth()+1)}</span>
                                                    <span>At√©: {formatDateVisual(customEnd).split(' de ')[0] + '/' + (new Date(customEnd).getMonth()+1)}</span>
                                                </div>
                                            )}

                                            <div className="grid grid-cols-2 gap-4">
                                                
                                                {/* STATUS CARD */}
                                                <Card style={{animationDelay: '240ms'}} onClick={() => openModal('status', 'Estado do Fio', stats.topStatus.icon, `${colors.yellow} bg-opacity-30`, stats.topStatus.color, stats.topStatus.label, colors.textStrong)} colors={colors} className="cascade-item col-span-2 flex justify-between items-center relative overflow-hidden group cursor-pointer hover:shadow-md transition-all">
                                                    <div className="absolute inset-0 bg-black/5 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                                                    <div><p className={`text-sm ${colors.textLight} font-bold uppercase tracking-wider mb-1`}>Como tem estado?</p><h3 className={`text-xl font-bold ${colors.textStrong}`}>{stats.topStatus.label}</h3></div>
                                                    <div className={`p-4 rounded-2xl ${colors.yellow} bg-opacity-30`}><i className={`ph-fill ${stats.topStatus.icon} ${stats.topStatus.color} text-4xl`}></i></div>
                                                </Card>

                                                {/* LAVAGENS */}
                                                <Card style={{animationDelay: '360ms'}} onClick={() => openModal('washed', 'Frequ√™ncia de Lavagem', 'ph-drop', `bg-blue-100 dark:bg-blue-900/30`, 'text-blue-500', `${stats.totalWashes}x`, 'text-blue-500')} colors={colors} className={`cascade-item col-span-2 bg-blue-50/50 dark:bg-blue-900/10 border-blue-100 dark:border-blue-900/50 flex justify-between items-center p-6 relative overflow-hidden group border-2 cursor-pointer hover:shadow-md transition-all`}>
                                                    <div className="absolute inset-0 bg-black/5 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                                                    <div>
                                                        <p className={`text-xs font-bold uppercase tracking-widest text-blue-400 dark:text-blue-300 mb-1`}>Cabelo Lavado</p>
                                                        <p className={`text-2xl font-black text-blue-600 dark:text-blue-400`}><span className="text-3xl">{stats.totalWashes}</span> vezes</p>
                                                        <p className={`text-xs font-bold mt-1 text-blue-500/70`}>em {stats.daysCount} dia(s)</p>
                                                    </div>
                                                    <i className="ph-fill ph-drop text-blue-500/30 text-6xl"></i>
                                                </Card>

                                                {/* TRATAMENTO */}
                                                <Card style={{animationDelay: '480ms'}} onClick={() => openModal('treatment', 'Tratamentos', 'ph-magic-wand', `${colors.emerald} bg-opacity-20`, colors.emeraldText, `${stats.treatUses}x`, colors.emeraldText)} colors={colors} className={`cascade-item col-span-1 flex flex-col items-center text-center gap-2 p-5 ${colors.emerald} bg-opacity-20 relative overflow-hidden group border-none cursor-pointer hover:shadow-md transition-all`}>
                                                    <div className="absolute inset-0 bg-black/5 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                                                    <i className={`ph-fill ph-magic-wand ${colors.emeraldText} text-4xl mb-1`}></i>
                                                    <p className={`text-xs font-bold uppercase tracking-widest ${colors.textLight}`}>M√°scara</p>
                                                    <p className={`text-3xl font-black ${colors.emeraldText}`}>{stats.treatUses}x</p>
                                                </Card>

                                                {/* ROTINA */}
                                                <Card style={{animationDelay: '600ms'}} onClick={() => openModal('routine', 'Ades√£o Rotina', 'ph-flask', `${colors.blueCard}`, colors.blueTextAlt, stats.routineAdherence !== null ? `${stats.routineAdherence}%` : 'N/A', colors.textStrong)} colors={colors} className={`cascade-item col-span-1 flex flex-col items-center text-center gap-2 p-5 ${colors.blueCard} relative overflow-hidden group border-none cursor-pointer hover:shadow-md transition-all`}>
                                                    <div className="absolute inset-0 bg-black/5 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                                                    <i className={`ph-fill ph-flask ${colors.blueText} text-4xl mb-1`}></i>
                                                    <p className={`text-xs font-bold uppercase tracking-widest ${colors.textLight}`}>Produtos</p>
                                                    <p className={`text-3xl font-black ${colors.blueTextAlt}`}>{stats.routineAdherence !== null ? `${stats.routineAdherence}%` : 'N/A'}</p>
                                                </Card>

                                                {/* SAL√ÉO */}
                                                <Card style={{animationDelay: '720ms'}} onClick={() => openModal('salon', 'Ida ao Sal√£o', 'ph-scissors', `${colors.purpleCard}`, colors.purpleText, `${stats.totalSalon} vezes`, colors.purpleText)} colors={colors} className={`cascade-item col-span-2 ${colors.purpleCard} relative overflow-hidden group cursor-pointer hover:shadow-md transition-all`}>
                                                    <div className="absolute inset-0 bg-black/5 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                                                    <div className="flex justify-between items-start mb-4">
                                                        <h3 className={`font-bold ${colors.textStrong} flex items-center gap-2`}><i className={`ph-fill ph-scissors ${colors.purpleText} text-2xl`}></i> Sal√£o</h3>
                                                        {stats.topSalonMood && <div className="text-right"><p className={`text-xs ${colors.textMuted} mb-1 font-bold`}>Resultado Geral</p><i className={`ph-fill ${stats.topSalonMood.icon} ${stats.topSalonMood.color} text-2xl`}></i></div>}
                                                    </div>
                                                    <div className={`${colors.translucentStrong} p-4 rounded-2xl flex justify-between items-center shadow-sm`}>
                                                        <span className={`text-sm font-bold ${colors.textLight}`}>Mimos profissionais</span>
                                                        <span className={`text-2xl font-black ${colors.purpleText}`}>{stats.totalSalon}</span>
                                                    </div>
                                                </Card>

                                                {/* CALOR */}
                                                <Card style={{animationDelay: '840ms'}} onClick={() => openModal('heat', 'Uso de Calor', 'ph-fire', `${colors.orange} bg-opacity-20`, colors.orangeText, `${stats.heatDays} dias`, colors.orangeText)} colors={colors} className={`cascade-item col-span-2 flex justify-between items-center p-6 ${colors.orange} bg-opacity-20 relative overflow-hidden group border-none cursor-pointer hover:shadow-md transition-all`}>
                                                    <div className="absolute inset-0 bg-black/5 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                                                    <div>
                                                        <p className={`text-xs font-bold uppercase tracking-widest ${colors.textLight} mb-1`}>Secador / Chapinha</p>
                                                        <p className={`text-3xl font-black ${colors.orangeText}`}>{stats.heatDays} <span className="text-sm font-bold">dias</span></p>
                                                        {stats.heatDays > 0 && <p className={`text-xs font-bold mt-1 ${stats.protectedDays === stats.heatDays ? 'text-green-600' : 'text-red-500'}`}>{stats.protectedDays} com prote√ß√£o t√©rmica</p>}
                                                    </div>
                                                    <i className="ph-fill ph-fire text-orange-500 text-5xl opacity-80"></i>
                                                </Card>

                                                {/* EXTRAS */}
                                                <Card style={{animationDelay: '960ms'}} onClick={() => openModal('extras', 'Extras', 'ph-hand-heart', `${colors.teal} bg-opacity-20`, colors.tealText, `${stats.totalExtrasMins}m`, colors.tealText)} colors={colors} className={`cascade-item col-span-2 flex justify-between items-center p-6 relative overflow-hidden group border-2 ${colors.border} cursor-pointer hover:shadow-md transition-all`}>
                                                    <div className="absolute inset-0 bg-black/5 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                                                    <div className="flex items-center gap-4">
                                                        <div className={`p-4 rounded-2xl ${colors.teal} bg-opacity-20`}><i className={`ph-fill ph-hand-heart ${colors.tealText} text-3xl`}></i></div>
                                                        <div>
                                                            <p className={`text-xs font-bold uppercase tracking-widest ${colors.textLight} mb-0.5`}>Massagens & Cuidados</p>
                                                            <p className={`text-xl font-black ${colors.textStrong}`}>{stats.totalExtrasMins} <span className="text-sm font-bold">minutos</span></p>
                                                        </div>
                                                    </div>
                                                </Card>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            
                            </div>
                        </div>

                        {/* --- DYNAMIC ISLAND (MENU INFERIOR) --- */}
                        <div 
                            className={`absolute bottom-6 left-1/2 -translate-x-1/2 w-[90%] max-w-[340px] flex flex-col items-center ${colors.bottomNav} backdrop-blur-xl border ${colors.border} rounded-[2rem] z-[60] shadow-[0_10px_40px_rgba(0,0,0,0.15)] transition-all duration-300 ease-[cubic-bezier(0.32,0.72,0,1)] overflow-hidden ${isNavOpen ? 'h-[130px]' : 'h-14'}`}
                        >
                            <div 
                                className="w-full h-14 flex flex-col justify-center items-center shrink-0 cursor-pointer hover:bg-black/5 transition-colors absolute top-0 z-10" 
                                onTouchStart={handleNavTouchStart}
                                onTouchMove={handleNavTouchMove}
                                onTouchEnd={handleNavTouchEnd}
                                onClick={handleNavClick}
                            >
                                <div className={`flex flex-col gap-1 mb-1 mt-1 pointer-events-none ${!isNavOpen && 'grip-animate'}`}>
                                    <div className={`w-8 h-1 rounded-full ${colors.primary} shadow-sm`}></div>
                                    <div className={`w-8 h-1 rounded-full ${colors.primary} shadow-sm`}></div>
                                </div>
                            </div>
                            
                            <div className={`w-full h-full flex justify-center items-center gap-3 sm:gap-6 pt-12 px-2 pb-2 transition-opacity duration-300 ${isNavOpen ? 'opacity-100 delay-100' : 'opacity-0 pointer-events-none'}`}>
                                <button onClick={(e) => { e.stopPropagation(); handleNavMenuClick('home'); }} className={`flex-1 max-w-[90px] py-2.5 rounded-2xl flex flex-col items-center gap-1.5 transition-all hover:scale-105 ${activeTab === 'home' ? `${colors.primary} ${colors.primaryText} shadow-sm` : colors.textLight}`}>
                                    <i className="ph-fill ph-hand-heart text-[26px]"></i><span className="text-[10px] font-bold uppercase tracking-wider">Di√°rio</span>
                                </button>
                                <button onClick={(e) => { e.stopPropagation(); handleNavMenuClick('calendar'); }} className={`flex-1 max-w-[90px] py-2.5 rounded-2xl flex flex-col items-center gap-1.5 transition-all hover:scale-105 ${activeTab === 'calendar' ? `${colors.primary} ${colors.primaryText} shadow-sm` : colors.textLight}`}>
                                    <i className="ph-fill ph-calendar-blank text-[26px]"></i><span className="text-[10px] font-bold uppercase tracking-wider">Hist√≥rico</span>
                                </button>
                                <button onClick={(e) => { e.stopPropagation(); handleNavMenuClick('stats'); }} className={`flex-1 max-w-[90px] py-2.5 rounded-2xl flex flex-col items-center gap-1.5 transition-all hover:scale-105 ${activeTab === 'stats' ? `${colors.primary} ${colors.primaryText} shadow-sm` : colors.textLight}`}>
                                    <i className="ph-fill ph-sparkle text-[26px]"></i><span className="text-[10px] font-bold uppercase tracking-wider">Resumo</span>
                                </button>
                            </div>
                        </div>

                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>


